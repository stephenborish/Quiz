<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Secure Assessment Platform - Real-time exam proctoring and analytics">
  <meta name="theme-color" content="#1a1a2e">
  <title><?= appTitle ?></title>

  <!-- ============================================
       EMBEDDED CSS STYLES
       ============================================ -->
  <style>
    /* ==========================================
       CSS VARIABLES & RESET
       ========================================== */
    :root {
      color-scheme: light;
      --primary: #667eea;
      --primary-dark: #5a67d8;
      --secondary: #764ba2;
      --success: #48bb78;
      --success-dark: #38a169;
      --danger: #f56565;
      --danger-dark: #e53e3e;
      --warning: #ed8936;
      --info: #4299e1;
      --dark: #f8fafc;
      --darker: #edf2f7;
      --darkest: #e2e8f0;
      --light: #1a202c;
      --gray: #4a5568;
      --gray-dark: #2d3748;
      --gray-light: #e2e8f0;
      --border-radius: 12px;
      --border-radius-lg: 20px;
      --shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.2);
      --transition: all 0.3s ease;
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: auto;
    }

    body {
      font-family: var(--font-family);
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: var(--light);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* ==========================================
       LAYOUT STRUCTURE
       ========================================== */
    .app-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: #ffffff;
      border-bottom: 1px solid var(--gray-light);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      z-index: 100;
      box-shadow: 0 2px 12px rgba(15, 23, 42, 0.06);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-logo {
      font-size: 22px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-version {
      font-size: 11px;
      color: var(--gray);
      background: #edf2f7;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .header-user {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-email {
      font-size: 13px;
      color: var(--gray);
    }

    .user-badge {
      padding: 5px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .user-badge.teacher {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
    }

    .user-badge.student {
      background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
      color: white;
    }

    .main-content {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* ==========================================
       TAB NAVIGATION (Teacher)
       ========================================== */
    .tab-nav {
      display: flex;
      background: #f1f5f9;
      padding: 0 20px;
      border-bottom: 1px solid var(--gray-light);
      overflow-x: auto;
      flex-shrink: 0;
    }

    .tab-btn {
      background: none;
      border: none;
      color: var(--gray);
      padding: 15px 25px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 3px solid transparent;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab-btn:hover {
      color: var(--gray-dark);
      background: #e2e8f0;
    }

    .tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: #e2e8f0;
    }

    .tab-icon {
      font-size: 16px;
    }

    .tab-content {
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .tab-panel {
      display: none;
      height: 100%;
      overflow-y: auto;
      padding: 20px;
    }

    .tab-panel.active {
      display: block;
    }

    /* ==========================================
       CARDS & CONTAINERS
       ========================================== */
    .card {
      background: #ffffff;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-light);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
    }

    .card-actions {
      display: flex;
      gap: 10px;
    }

    /* ==========================================
       BUTTONS
       ========================================== */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(72, 187, 120, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(245, 101, 101, 0.4);
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid #cbd5e0;
      color: var(--gray-dark);
    }

    .btn-outline:hover {
      border-color: var(--primary);
      background: #edf2f7;
    }

    .btn-sm {
      padding: 6px 14px;
      font-size: 12px;
    }

    .btn-lg {
      padding: 15px 35px;
      font-size: 16px;
    }

    /* ==========================================
       FORMS
       ========================================== */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 16px;
      background: #ffffff;
      border: 2px solid #cbd5e0;
      border-radius: var(--border-radius);
      color: var(--gray-dark);
      font-size: 14px;
      transition: var(--transition);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: #ffffff;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-input::placeholder {
      color: var(--gray);
    }

    /* ==========================================
       TABLES
       ========================================== */
    .table-container {
      overflow-x: auto;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-light);
      background: #ffffff;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      background: #f8fafc;
      padding: 14px 16px;
      text-align: left;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray);
    }

    .data-table td {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 14px;
    }

    .data-table tr:hover {
      background: #f1f5f9;
    }

    /* ==========================================
       STATUS BADGES
       ========================================== */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-badge.active {
      background: rgba(72, 187, 120, 0.2);
      color: var(--success);
    }

    .status-badge.blocked {
      background: rgba(245, 101, 101, 0.2);
      color: var(--danger);
    }

    .status-badge.completed {
      background: rgba(66, 153, 225, 0.2);
      color: var(--info);
    }

    .status-badge.draft {
      background: rgba(160, 174, 192, 0.2);
      color: var(--gray);
    }

    .status-badge.open {
      background: rgba(72, 187, 120, 0.2);
      color: var(--success);
    }

    .status-badge.closed {
      background: rgba(245, 101, 101, 0.2);
      color: var(--danger);
    }

    /* ==========================================
       UPLOAD & PROGRESS
       ========================================== */
    .upload-zone {
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: var(--border-radius);
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .upload-zone:hover {
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.1);
    }

    .upload-zone.dragover {
      border-color: var(--success);
      background: rgba(72, 187, 120, 0.1);
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    .upload-text {
      color: var(--gray);
      font-size: 14px;
    }

    .progress-bar {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .image-preview {
      max-width: 200px;
      max-height: 150px;
      border-radius: var(--border-radius);
      margin-top: 10px;
    }

    /* ==========================================
       THE MATRIX (Analytics Grid)
       ========================================== */
    .matrix-container {
      display: flex;
      gap: 20px;
      height: calc(100% - 60px);
    }

    .matrix-grid {
      flex: 1;
      position: relative;
      background: rgba(0, 0, 0, 0.3);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255, 255, 255, 0.1);
      min-height: 400px;
    }

    .matrix-quadrant {
      position: absolute;
      width: 50%;
      height: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 10px;
    }

    .matrix-quadrant.top-left {
      top: 0;
      left: 0;
      background: rgba(237, 137, 54, 0.1);
    }

    .matrix-quadrant.top-right {
      top: 0;
      right: 0;
      background: rgba(72, 187, 120, 0.1);
    }

    .matrix-quadrant.bottom-left {
      bottom: 0;
      left: 0;
      background: rgba(245, 101, 101, 0.1);
    }

    .matrix-quadrant.bottom-right {
      bottom: 0;
      right: 0;
      background: rgba(66, 153, 225, 0.1);
    }

    .quadrant-label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.6;
      margin-bottom: 10px;
    }

    .quadrant-dots {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
    }

    .student-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }

    .student-dot:hover {
      transform: scale(1.5);
      z-index: 10;
    }

    .student-dot.misconception {
      background: var(--danger);
      animation: pulse-danger 1.5s infinite;
    }

    .student-dot.correct-confident {
      background: var(--success);
    }

    .student-dot.correct-unsure {
      background: var(--info);
    }

    .student-dot.incorrect-unsure {
      background: var(--warning);
    }

    @keyframes pulse-danger {
      0%, 100% { box-shadow: 0 0 0 0 rgba(245, 101, 101, 0.7); }
      50% { box-shadow: 0 0 0 8px rgba(245, 101, 101, 0); }
    }

    .matrix-legend {
      width: 250px;
      padding: 15px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: var(--border-radius);
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
    }

    .legend-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .legend-text {
      font-size: 12px;
    }

    .axis-label {
      position: absolute;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray);
    }

    .axis-label.x-axis {
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
    }

    .axis-label.y-axis {
      left: -35px;
      top: 50%;
      transform: rotate(-90deg) translateX(-50%);
      transform-origin: left center;
    }

    /* ==========================================
       STUDENT EXAM VIEW
       ========================================== */
    .screen {
      display: none;
      height: 100%;
    }

    .screen.active {
      display: flex;
      flex-direction: column;
    }

    .waiting-room {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 40px;
    }

    .waiting-icon {
      font-size: 80px;
      margin-bottom: 25px;
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }

    .waiting-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .waiting-subtitle {
      font-size: 16px;
      color: var(--gray);
      max-width: 450px;
    }

    .waiting-status {
      margin-top: 30px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px 30px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 30px;
    }

    .pulse-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--warning);
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }

    /* Blocked Screen */
    .blocked-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #c0392b 0%, #6c1305 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      text-align: center;
      padding: 40px;
    }

    .blocked-icon {
      font-size: 100px;
      margin-bottom: 30px;
    }

    .blocked-title {
      font-size: 48px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 4px;
      margin-bottom: 20px;
    }

    .blocked-message {
      font-size: 18px;
      opacity: 0.9;
      max-width: 500px;
    }

    /* Exam Content */
    .exam-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 30px 20px;
      width: 100%;
    }

    .question-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius-lg);
      padding: 35px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .question-number {
      font-size: 13px;
      color: var(--gray);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .quiz-badge {
      background: var(--primary);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .question-text {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .question-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: var(--border-radius);
      margin-bottom: 25px;
    }

    .options-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .option-btn {
      background: #ffffff;
      border: 2px solid #e2e8f0;
      border-radius: var(--border-radius);
      padding: 16px 20px;
      color: var(--gray-dark);
      font-size: 15px;
      text-align: left;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .option-btn:hover {
      background: #f8fafc;
      border-color: var(--primary);
    }

    .option-btn.selected {
      background: rgba(102, 126, 234, 0.12);
      border-color: var(--primary);
    }

    .option-letter {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #edf2f7;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }

    .option-btn.selected .option-letter {
      background: var(--primary);
    }

    .option-content {
      flex: 1;
    }

    .option-image {
      max-width: 150px;
      max-height: 100px;
      border-radius: 8px;
      margin-top: 10px;
    }

    /* Metacognition Modal */
    .metacognition-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9000;
      padding: 20px;
    }

    .metacognition-content {
      background: #ffffff;
      border-radius: var(--border-radius-lg);
      padding: 40px;
      max-width: 500px;
      width: 100%;
      text-align: center;
      border: 1px solid var(--gray-light);
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.15);
    }

    .metacognition-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .metacognition-subtitle {
      font-size: 14px;
      color: var(--gray);
      margin-bottom: 30px;
    }

    .confidence-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 30px;
    }

    .confidence-btn {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: var(--border-radius);
      padding: 20px 15px;
      color: var(--gray-dark);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
    }

    .confidence-btn:hover {
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.1);
    }

    .confidence-btn.selected {
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.2);
    }

    .confidence-level {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 5px;
    }

    .confidence-label {
      font-size: 13px;
      color: var(--gray);
    }

    .metacognition-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 20px;
      font-size: 16px;
      color: var(--gray);
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
    }

    .toast {
      background: rgba(30, 30, 50, 0.95);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 15px 20px;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    .toast.warning { border-left: 4px solid var(--warning); }
    .toast.info { border-left: 4px solid var(--info); }

    /* ==========================================
       QUIZ BUILDER STYLES
       ========================================== */
    .quiz-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .quiz-card {
      background: #ffffff;
      border-radius: var(--border-radius);
      padding: 20px;
      border: 1px solid var(--gray-light);
      transition: var(--transition);
    }

    .quiz-card:hover {
      border-color: var(--primary);
      transform: translateY(-3px);
    }

    .quiz-card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .quiz-card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
    }

    .question-count {
      font-size: 13px;
      color: var(--gray);
    }

    .question-editor {
      background: #f8fafc;
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--gray-light);
    }

    .option-editor {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
      padding: 15px;
      background: #ffffff;
      border-radius: var(--border-radius);
    }

    #questionsList {
      max-height: 60vh;
      overflow-y: scroll;
      padding-right: 6px;
      scrollbar-width: auto;
      scrollbar-color: #cbd5e0 #edf2f7;
    }

    #questionsList::-webkit-scrollbar {
      width: 12px;
    }

    #questionsList::-webkit-scrollbar-track {
      background: #edf2f7;
      border-radius: 10px;
    }

    #questionsList::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 10px;
      border: 3px solid #edf2f7;
    }

    #questionsList::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
    }

    .option-editor .form-input {
      flex: 1;
    }

    .correct-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .correct-checkbox input {
      width: 18px;
      height: 18px;
      accent-color: var(--success);
    }

    /* ==========================================
       RESPONSIVE DESIGN
       ========================================== */
    @media (max-width: 768px) {
      .header {
        padding: 10px 15px;
      }

      .header-logo {
        font-size: 18px;
      }

      .header-version {
        display: none;
      }

      .tab-btn {
        padding: 12px 15px;
        font-size: 13px;
      }

      .tab-btn span:not(.tab-icon) {
        display: none;
      }

      .matrix-container {
        flex-direction: column;
      }

      .matrix-legend {
        width: 100%;
      }

      .question-text {
        font-size: 18px;
      }

      .confidence-options {
        grid-template-columns: 1fr;
      }
    }

    /* ==========================================
       UTILITY CLASSES
       ========================================== */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .text-success { color: var(--success); }
    .text-danger { color: var(--danger); }
    .text-warning { color: var(--warning); }
    .text-muted { color: var(--gray); }
    .mt-10 { margin-top: 10px; }
    .mt-20 { margin-top: 20px; }
    .mb-10 { margin-bottom: 10px; }
    .mb-20 { margin-bottom: 20px; }
    .flex { display: flex; }
    .flex-center { display: flex; align-items: center; justify-content: center; }
    .gap-10 { gap: 10px; }
    .gap-20 { gap: 20px; }
  </style>
</head>
<body>
  <!-- ============================================
       LOADING OVERLAY
       ============================================ -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Initializing Secure Assessment Platform...</div>
  </div>

  <!-- ============================================
       BLOCKED SCREEN (Students Only)
       ============================================ -->
  <div id="blockedScreen" class="blocked-screen hidden">
    <div class="blocked-icon">üö´</div>
    <h1 class="blocked-title">Session Locked</h1>
    <p class="blocked-message">
      A tab switch or window change was detected.<br><br>
      Please see your teacher to continue.
    </p>
  </div>

  <!-- ============================================
       MAIN APPLICATION
       ============================================ -->
  <div id="app" class="app-container hidden">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <h1 class="header-logo">Secure Assessment</h1>
        <span class="header-version">v<?= appVersion ?></span>
      </div>
      <div class="header-user">
        <span class="user-email"><?= userEmail ?></span>
        <span id="userBadge" class="user-badge <?= isTeacher ? 'teacher' : 'student' ?>">
          <?= userRole ?>
        </span>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- ==========================================
           TEACHER COMMAND CENTER
           ========================================== -->
      <div id="teacherView" class="<?= isTeacher ? '' : 'hidden' ?>">
        <!-- Tab Navigation -->
        <nav class="tab-nav">
          <button class="tab-btn active" data-tab="proctoring">
            <span class="tab-icon">üëÅÔ∏è</span>
            <span>Live Proctoring</span>
          </button>
          <button class="tab-btn" data-tab="builder">
            <span class="tab-icon">üìù</span>
            <span>Quiz Builder</span>
          </button>
          <button class="tab-btn" data-tab="matrix">
            <span class="tab-icon">üìä</span>
            <span>The Matrix</span>
          </button>
          <button class="tab-btn" data-tab="admin">
            <span class="tab-icon">‚öôÔ∏è</span>
            <span>Admin Panel</span>
          </button>
        </nav>

        <!-- Tab Content -->
        <div class="tab-content">
          <!-- Live Proctoring Panel -->
          <div id="proctoringPanel" class="tab-panel active">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Quiz Control</h2>
                <div class="card-actions">
                  <select id="activeQuizSelect" class="form-select" style="width: 200px;">
                    <option value="">Select Quiz...</option>
                  </select>
                  <button id="openQuizBtn" class="btn btn-success" onclick="toggleQuizStatus('OPEN')">
                    Open Quiz
                  </button>
                  <button id="closeQuizBtn" class="btn btn-danger" onclick="toggleQuizStatus('CLOSED')">
                    Close Quiz
                  </button>
                  <button id="sendInvitesBtn" class="btn btn-outline" onclick="sendInvitesForActiveQuiz()" disabled>
                    Send Invites
                  </button>
                </div>
              </div>
              <div id="quizStatusBanner" class="hidden" style="padding: 15px; border-radius: 8px; text-align: center; font-weight: 600;"></div>
            </div>

            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Live Student Roster</h2>
                <span id="studentCount" class="status-badge active">0 Students</span>
              </div>
              <div class="table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Student Email</th>
                      <th>Connection</th>
                      <th>Status</th>
                      <th>Progress</th>
                      <th>Violations</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="rosterBody">
                    <tr>
                      <td colspan="6" class="text-center text-muted">No students connected</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Quiz Builder Panel -->
          <div id="builderPanel" class="tab-panel">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Your Quizzes</h2>
                <button class="btn btn-primary" onclick="showCreateQuizModal()">
                  + Create New Quiz
                </button>
              </div>
              <div id="quizList" class="quiz-list">
                <!-- Populated by JavaScript -->
              </div>
            </div>

            <!-- Question Editor (Hidden by default) -->
            <div id="questionEditorSection" class="card hidden">
              <div class="card-header">
                <h2 class="card-title">
                  <span id="editingQuizTitle">Quiz Questions</span>
                </h2>
                <div class="card-actions">
                  <button class="btn btn-outline" onclick="saveAllQuestions()">
                    Save All
                  </button>
                  <button class="btn btn-outline" onclick="closeQuestionEditor()">
                    Back to Quizzes
                  </button>
                </div>
              </div>

              <div id="questionsList">
                <!-- Populated by JavaScript -->
              </div>

              <button class="btn btn-primary mt-20" onclick="addNewQuestion()">
                + Add Question
              </button>
            </div>
          </div>

          <!-- The Matrix (Analytics) Panel -->
          <div id="matrixPanel" class="tab-panel">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">The Metacognition Matrix</h2>
                <select id="matrixQuizSelect" class="form-select" style="width: 200px;">
                  <option value="">Select Quiz...</option>
                </select>
              </div>

              <div class="matrix-container">
                <div class="matrix-grid">
                  <span class="axis-label y-axis">CONFIDENCE</span>
                  <span class="axis-label x-axis">ACCURACY</span>

                  <!-- Top Left: High Confidence / Incorrect = MISCONCEPTION -->
                  <div class="matrix-quadrant top-left">
                    <div class="quadrant-label" style="color: var(--danger);">Active Misconception</div>
                    <div id="quadrantTL" class="quadrant-dots"></div>
                  </div>

                  <!-- Top Right: High Confidence / Correct = MASTERY -->
                  <div class="matrix-quadrant top-right">
                    <div class="quadrant-label" style="color: var(--success);">Mastery</div>
                    <div id="quadrantTR" class="quadrant-dots"></div>
                  </div>

                  <!-- Bottom Left: Low Confidence / Incorrect = LEARNING -->
                  <div class="matrix-quadrant bottom-left">
                    <div class="quadrant-label" style="color: var(--warning);">Learning</div>
                    <div id="quadrantBL" class="quadrant-dots"></div>
                  </div>

                  <!-- Bottom Right: Low Confidence / Correct = LUCKY GUESS -->
                  <div class="matrix-quadrant bottom-right">
                    <div class="quadrant-label" style="color: var(--info);">Lucky Guess</div>
                    <div id="quadrantBR" class="quadrant-dots"></div>
                  </div>
                </div>

                <div class="matrix-legend">
                  <h3 style="font-size: 14px; margin-bottom: 15px; color: var(--gray);">LEGEND</h3>

                  <div class="legend-item" style="background: rgba(245, 101, 101, 0.2);">
                    <div class="legend-dot" style="background: var(--danger);"></div>
                    <div class="legend-text">
                      <strong style="color: var(--danger);">Active Misconception</strong><br>
                      <span class="text-muted">High confidence + Wrong</span>
                    </div>
                  </div>

                  <div class="legend-item" style="background: rgba(72, 187, 120, 0.2);">
                    <div class="legend-dot" style="background: var(--success);"></div>
                    <div class="legend-text">
                      <strong style="color: var(--success);">Mastery</strong><br>
                      <span class="text-muted">High confidence + Correct</span>
                    </div>
                  </div>

                  <div class="legend-item" style="background: rgba(237, 137, 54, 0.2);">
                    <div class="legend-dot" style="background: var(--warning);"></div>
                    <div class="legend-text">
                      <strong style="color: var(--warning);">Learning</strong><br>
                      <span class="text-muted">Low confidence + Wrong</span>
                    </div>
                  </div>

                  <div class="legend-item" style="background: rgba(66, 153, 225, 0.2);">
                    <div class="legend-dot" style="background: var(--info);"></div>
                    <div class="legend-text">
                      <strong style="color: var(--info);">Lucky Guess</strong><br>
                      <span class="text-muted">Low confidence + Correct</span>
                    </div>
                  </div>

                  <div class="mt-20">
                    <div id="matrixStats" class="text-muted" style="font-size: 13px;">
                      Select a quiz to view analytics
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Admin Panel -->
          <div id="adminPanel" class="tab-panel">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Rosters (Courses)</h2>
              </div>

              <div class="form-group">
                <label class="form-label">Create Course</label>
                <div class="flex gap-10">
                  <input type="text" id="newCourseName" class="form-input" placeholder="Course name" style="flex: 2;">
                  <input type="text" id="newCourseBlock" class="form-input" placeholder="Block" style="flex: 1;">
                  <button class="btn btn-success" onclick="createCourse()">Create</button>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Select Course</label>
                <select id="courseSelect" class="form-select">
                  <option value="">Select course...</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">Import Roster CSV (email,name,block)</label>
                <textarea id="rosterCsvInput" class="form-textarea" placeholder="student1@example.com,Student One,A&#10;student2@example.com,Student Two,B"></textarea>
                <div class="mt-10">
                  <button class="btn btn-primary" onclick="importRoster()">Import / Update Roster</button>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Authorized Teachers</h2>
              </div>

              <div class="form-group">
                <label class="form-label">Add New Teacher</label>
                <div class="flex gap-10">
                  <input type="email" id="newTeacherEmail" class="form-input" placeholder="teacher@school.edu" style="flex: 1;">
                  <button class="btn btn-success" onclick="addTeacher()">Add Teacher</button>
                </div>
              </div>

              <div class="table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Email</th>
                      <th>Display Name</th>
                      <th>Role</th>
                      <th>Added</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="teachersList">
                    <tr>
                      <td colspan="5" class="text-center text-muted">Loading teachers...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==========================================
           STUDENT EXAM VIEW
           ========================================== -->
      <div id="studentView" class="<?= isTeacher ? 'hidden' : '' ?>" style="height: 100%;">
        <!-- Waiting Room -->
        <div id="waitingScreen" class="screen active">
          <div class="waiting-room">
            <div class="waiting-icon">‚è≥</div>
            <h1 class="waiting-title">Waiting Room</h1>
            <p class="waiting-subtitle">
              Your teacher is preparing the assessment. Please wait here and keep this tab focused.
            </p>
            <div class="waiting-status">
              <div class="pulse-dot"></div>
              <span>Waiting for quiz to open...</span>
            </div>
          </div>
        </div>

        <!-- Exam Screen -->
        <div id="examScreen" class="screen">
          <div class="exam-container">
            <div class="question-card">
              <div class="question-header">
                <span id="questionCounter" class="question-number">Question 1 of 1</span>
                <span id="quizBadge" class="quiz-badge">Quiz</span>
              </div>

              <h2 id="questionText" class="question-text">Loading question...</h2>
              <img id="questionImage" class="question-image hidden" src="" alt="Question image">

              <div id="optionsList" class="options-list">
                <!-- Populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>

        <!-- Completed Screen -->
        <div id="completedScreen" class="screen">
          <div class="waiting-room">
            <div class="waiting-icon">‚úÖ</div>
            <h1 class="waiting-title" style="color: var(--success);">Assessment Complete!</h1>
            <p class="waiting-subtitle">
              Your responses have been recorded. Please wait for your teacher's instructions.
            </p>
            <div id="completionSummary" class="mt-20" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
              <!-- Summary populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ============================================
       METACOGNITION MODAL
       ============================================ -->
  <div id="metacognitionModal" class="metacognition-modal hidden">
    <div class="metacognition-content">
      <h2 class="metacognition-title">How confident are you?</h2>
      <p class="metacognition-subtitle">
        Your answer: <strong id="selectedAnswerPreview">...</strong>
      </p>

      <div class="confidence-options">
        <button class="confidence-btn" data-confidence="1" onclick="selectConfidence(1)">
          <div class="confidence-level">1</div>
          <div class="confidence-label">Guessed</div>
        </button>
        <button class="confidence-btn" data-confidence="2" onclick="selectConfidence(2)">
          <div class="confidence-level">2</div>
          <div class="confidence-label">Unsure</div>
        </button>
        <button class="confidence-btn" data-confidence="3" onclick="selectConfidence(3)">
          <div class="confidence-level">3</div>
          <div class="confidence-label">Confident</div>
        </button>
        <button class="confidence-btn" data-confidence="4" onclick="selectConfidence(4)">
          <div class="confidence-level">4</div>
          <div class="confidence-label">Certain</div>
        </button>
      </div>

      <div class="metacognition-actions">
        <button class="btn btn-outline" onclick="cancelMetacognition()">Change Answer</button>
        <button id="submitWithConfidenceBtn" class="btn btn-success" onclick="submitWithConfidence()" disabled>
          Submit Answer
        </button>
      </div>
    </div>
  </div>

  <!-- ============================================
       CREATE QUIZ MODAL
       ============================================ -->
  <div id="createQuizModal" class="metacognition-modal hidden">
    <div class="metacognition-content">
      <h2 class="metacognition-title">Create New Quiz</h2>

      <div class="form-group">
        <label class="form-label">Quiz Title</label>
        <input type="text" id="newQuizTitle" class="form-input" placeholder="e.g., Chapter 5 Review">
      </div>

      <div class="form-group">
        <label class="form-label">Description (optional)</label>
        <textarea id="newQuizDescription" class="form-textarea" placeholder="Brief description..."></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Attach Roster (optional)</label>
        <select id="newQuizRosterSelect" class="form-select">
          <option value="">No roster</option>
        </select>
      </div>

      <div class="metacognition-actions">
        <button class="btn btn-outline" onclick="closeCreateQuizModal()">Cancel</button>
        <button class="btn btn-success" onclick="createNewQuiz()">Create Quiz</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- ============================================
       FIREBASE SDK (Compat 9.22.0)
       ============================================ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script> 
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <!-- ============================================
       MAIN APPLICATION JAVASCRIPT
       ============================================ -->
  <script>
    // ============================================
    // SERVER-INJECTED VARIABLES (TRUSTED)
    // ============================================
    const USER_EMAIL = '<?= userEmail ?>';
    const IS_TEACHER = <?= isTeacher ?>;
    const USER_ROLE = '<?= userRole ?>';
    const FIREBASE_CONFIG = <?!= firebaseConfig ?>;
    const APP_URL = '<?= appUrl ?>';

    // ============================================
    // INITIALIZE FIREBASE
    // ============================================
    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ============================================
    // APPLICATION STATE
    // ============================================
    const AppState = {
      // Common
      currentQuizId: null,
      unsubscribers: [],

      // Teacher
      quizzes: [],
      currentEditingQuiz: null,
      currentQuestions: [],
      courses: [],
      selectedCourseId: null,
      teachers: [],

      // Student
      isBlocked: false,
      currentQuestion: null,
      questions: [],
      currentQuestionIndex: 0,
      selectedAnswer: null,
      selectedConfidence: null,
      hasSubmitted: false,
      tabSwitchTimer: null,
      answers: {}
    };

    // ============================================
    // DOM REFERENCES
    // ============================================
    const DOM = {
      loadingOverlay: document.getElementById('loadingOverlay'),
      blockedScreen: document.getElementById('blockedScreen'),
      app: document.getElementById('app'),
      teacherView: document.getElementById('teacherView'),
      studentView: document.getElementById('studentView'),
      metacognitionModal: document.getElementById('metacognitionModal'),
      createQuizModal: document.getElementById('createQuizModal'),
      toastContainer: document.getElementById('toastContainer')
    };

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    /**
     * Fisher-Yates Shuffle Algorithm
     */
    function fisherYatesShuffle(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    /**
     * Normalize email for document ID consistency
     */
    function docIdFromEmail(email) {
      return (email || '').trim().toLowerCase();
    }

    /**
     * Show toast notification
     */
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <span style="font-size: 18px;">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
        <span>${message}</span>
      `;
      DOM.toastContainer.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    /**
     * Show/hide screens
     */
    function showScreen(screenId) {
      const screens = ['waitingScreen', 'examScreen', 'completedScreen'];
      screens.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.toggle('active', id === screenId);
        }
      });
    }

    /**
     * Format timestamp
     */
    function formatTime(timestamp) {
      if (!timestamp) return 'N/A';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleString();
    }

    // ============================================
    // INITIALIZATION
    // ============================================

async function initializeApp() {
      console.log('[INIT] Starting application...');
      
      // 1. WAIT FOR SIGN IN (Crucial Step)
      try {
        await firebase.auth().signInWithCustomToken('<?= authToken ?>');
        console.log('[AUTH] Signed in successfully');
      } catch (error) {
        console.error('[AUTH] Sign in failed', error);
        showToast('Authentication failed', 'error');
        return; // Stop app if auth fails
      }

      console.log('[INIT] User:', USER_EMAIL, 'Role:', USER_ROLE);

      try {
        if (IS_TEACHER) {
          await initializeTeacherDashboard();
        } else {
          await initializeStudentView();
        }

        DOM.loadingOverlay.classList.add('hidden');
        DOM.app.classList.remove('hidden');

      } catch (error) {
        console.error('[INIT] Failed:', error);
        showToast('Failed to initialize application', 'error');
      }
    }

    // ============================================
    // TEACHER DASHBOARD
    // ============================================

    async function initializeTeacherDashboard() {
      console.log('[TEACHER] Initializing dashboard...');

      // Setup tab navigation
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });

      // Load quizzes
      await loadQuizzes();
      await loadCourses();

      // Setup listeners
      setupTeacherListeners();
    }

    function switchTab(tabId) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabId);
      });
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.toggle('active', panel.id === `${tabId}Panel`);
      });
    }

    async function loadQuizzes() {
      try {
        const snapshot = await db.collection('quizzes')
          .where('createdBy', '==', USER_EMAIL)
          .orderBy('createdAt', 'desc')
          .get();

        AppState.quizzes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderQuizList();
        updateQuizSelects();

      } catch (error) {
        console.error('[TEACHER] Failed to load quizzes:', error);
        showToast('Failed to load quizzes', 'error');
      }
    }

    function renderQuizList() {
      const container = document.getElementById('quizList');

      if (AppState.quizzes.length === 0) {
        container.innerHTML = `
          <div class="text-center text-muted" style="grid-column: 1/-1; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 15px;">üìù</div>
            <p>No quizzes yet. Create your first quiz!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = AppState.quizzes.map(quiz => `
        <div class="quiz-card">
          <h3 class="quiz-card-title">${quiz.title || 'Untitled Quiz'}</h3>
          <p class="text-muted" style="font-size: 13px;">${quiz.description || 'No description'}</p>
          <div class="quiz-card-meta">
            <span class="status-badge ${quiz.status?.toLowerCase() || 'draft'}">${quiz.status || 'DRAFT'}</span>
            <div class="flex gap-10">
              <button class="btn btn-sm btn-outline" onclick="editQuiz('${quiz.id}')">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteQuiz('${quiz.id}')">Delete</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function updateQuizSelects() {
      const options = '<option value="">Select Quiz...</option>' +
        AppState.quizzes.map(q => `<option value="${q.id}">${q.title || 'Untitled'}</option>`).join('');

      document.getElementById('activeQuizSelect').innerHTML = options;
      document.getElementById('matrixQuizSelect').innerHTML = options;

      // Add change listeners
      document.getElementById('activeQuizSelect').onchange = (e) => {
        if (e.target.value) selectQuizForProctoring(e.target.value);
      };
      document.getElementById('matrixQuizSelect').onchange = (e) => {
        if (e.target.value) loadMatrixData(e.target.value);
      };
    }

    async function loadCourses() {
      try {
        const snapshot = await db.collection('courses')
          .orderBy('createdAt', 'desc')
          .get();

        AppState.courses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateCourseSelects();

      } catch (error) {
        console.error('[COURSES] Failed to load courses:', error);
        showToast('Failed to load courses', 'error');
      }
    }

    function updateCourseSelects() {
      const options = '<option value="">Select course...</option>' +
        AppState.courses.map(course => `
          <option value="${course.id}">${course.name || 'Course'}${course.block ? ` (${course.block})` : ''}</option>
        `).join('');

      const courseSelect = document.getElementById('courseSelect');
      const rosterSelect = document.getElementById('newQuizRosterSelect');

      if (courseSelect) {
        courseSelect.innerHTML = options;
        courseSelect.onchange = (e) => {
          AppState.selectedCourseId = e.target.value || null;
        };
      }

      if (rosterSelect) {
        rosterSelect.innerHTML = '<option value="">No roster</option>' + options;
      }
    }

    function showCreateQuizModal() {
      document.getElementById('newQuizTitle').value = '';
      document.getElementById('newQuizDescription').value = '';
      document.getElementById('newQuizRosterSelect').value = '';
      DOM.createQuizModal.classList.remove('hidden');
    }

    function closeCreateQuizModal() {
      DOM.createQuizModal.classList.add('hidden');
    }

    async function createNewQuiz() {
      const title = document.getElementById('newQuizTitle').value.trim();
      const description = document.getElementById('newQuizDescription').value.trim();
      const rosterCourseId = document.getElementById('newQuizRosterSelect').value || null;

      if (!title) {
        showToast('Please enter a quiz title', 'warning');
        return;
      }

      try {
        const quizRef = await db.collection('quizzes').add({
          title,
          description,
          status: 'DRAFT',
          createdBy: USER_EMAIL,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          rosterCourseId,
          settings: {
            shuffleQuestions: false,
            shuffleOptions: true,
            showResults: false
          }
        });

        closeCreateQuizModal();
        showToast('Quiz created successfully!', 'success');
        await loadQuizzes();
        editQuiz(quizRef.id);

      } catch (error) {
        console.error('[TEACHER] Failed to create quiz:', error);
        showToast('Failed to create quiz', 'error');
      }
    }

    async function editQuiz(quizId) {
      AppState.currentEditingQuiz = quizId;
      const quiz = AppState.quizzes.find(q => q.id === quizId);

      document.getElementById('editingQuizTitle').textContent = quiz?.title || 'Quiz Questions';
      document.getElementById('questionEditorSection').classList.remove('hidden');

      await loadQuestions(quizId);
    }

    async function loadQuestions(quizId) {
      try {
        const snapshot = await db.collection('quizzes').doc(quizId)
          .collection('questions').orderBy('order').get();

        const questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        AppState.currentQuestions = questions;
        renderQuestionsList(questions);

      } catch (error) {
        console.error('[TEACHER] Failed to load questions:', error);
        showToast('Failed to load questions', 'error');
      }
    }

    function renderQuestionsList(questions) {
      const container = document.getElementById('questionsList');

      if (questions.length === 0) {
        container.innerHTML = `
          <div class="text-center text-muted" style="padding: 30px;">
            No questions yet. Add your first question!
          </div>
        `;
        return;
      }

      container.innerHTML = questions.map((q, idx) => `
        <div class="question-editor" data-question-id="${q.id}">
          <div class="flex" style="justify-content: space-between; margin-bottom: 15px;">
            <strong>Question ${idx + 1}</strong>
            <div class="flex gap-10">
              <button class="btn btn-sm btn-outline" onclick="saveQuestion('${q.id}')">Save</button>
              <button class="btn btn-sm btn-danger" onclick="deleteQuestion('${q.id}')">Delete</button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Question Text</label>
            <textarea class="form-textarea" id="qtext_${q.id}" onchange="updateQuestion('${q.id}')">${q.text || ''}</textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Question Image (Optional)</label>
            <div class="upload-zone" onclick="triggerImageUpload('question', '${q.id}')">
              ${q.imageUrl ? `<img src="${q.imageUrl}" class="image-preview" id="qimg_preview_${q.id}">` : `
                <div class="upload-icon">üì∑</div>
                <div class="upload-text">Click to upload image</div>
              `}
            </div>
            <input type="file" id="qimg_input_${q.id}" class="hidden" accept="image/*" onchange="uploadQuestionImage('${q.id}', this)">
            <div id="qimg_progress_${q.id}" class="progress-bar hidden"><div class="progress-fill" style="width: 0%"></div></div>
          </div>

          <div class="form-group">
            <label class="form-label">Answer Options</label>
            <div id="options_${q.id}">
              ${(q.options || []).map((opt, optIdx) => `
                <div class="option-editor">
                  <input type="text" class="form-input" value="${opt.text || ''}"
                    onchange="updateOption('${q.id}', ${optIdx}, 'text', this.value)">
                  <label class="correct-checkbox">
                    <input type="radio" name="correct_${q.id}" ${opt.isCorrect ? 'checked' : ''}
                      onchange="updateOption('${q.id}', ${optIdx}, 'isCorrect', true)">
                    Correct
                  </label>
                  <button class="btn btn-sm btn-outline" onclick="triggerOptionImageUpload('${q.id}', ${optIdx})">
                    ${opt.imageUrl ? 'üñºÔ∏è' : 'üì∑'}
                  </button>
                  <input type="file" id="optimg_${q.id}_${optIdx}" class="hidden" accept="image/*"
                    onchange="uploadOptionImage('${q.id}', ${optIdx}, this)">
                </div>
              `).join('')}
            </div>
            <button class="btn btn-sm btn-outline mt-10" onclick="addOption('${q.id}')">+ Add Option</button>
          </div>
        </div>
      `).join('');
    }

    async function addNewQuestion() {
      if (!AppState.currentEditingQuiz) return;

      try {
        const questionsRef = db.collection('quizzes').doc(AppState.currentEditingQuiz).collection('questions');
        const snapshot = await questionsRef.get();
        const order = snapshot.size;

        await questionsRef.add({
          text: '',
          imageUrl: null,
          options: [
            { id: 'a', text: '', imageUrl: null, isCorrect: true },
            { id: 'b', text: '', imageUrl: null, isCorrect: false },
            { id: 'c', text: '', imageUrl: null, isCorrect: false },
            { id: 'd', text: '', imageUrl: null, isCorrect: false }
          ],
          order,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        await loadQuestions(AppState.currentEditingQuiz);
        showToast('Question added', 'success');

      } catch (error) {
        console.error('[TEACHER] Failed to add question:', error);
        showToast('Failed to add question', 'error');
      }
    }

    async function updateQuestion(questionId) {
      const text = document.getElementById(`qtext_${questionId}`).value;

      try {
        await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId)
          .update({ text, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      } catch (error) {
        console.error('[TEACHER] Failed to update question:', error);
      }
    }

    function buildQuestionDraft(questionId) {
      const question = AppState.currentQuestions.find(q => q.id === questionId);
      const text = document.getElementById(`qtext_${questionId}`)?.value ?? '';
      const optionRows = document.querySelectorAll(`#options_${questionId} .option-editor`);

      const options = Array.from(optionRows).map((row, idx) => {
        const input = row.querySelector('input.form-input');
        const radio = row.querySelector('input[type="radio"]');
        const baseOption = question?.options?.[idx] || {};

        return {
          id: baseOption.id || `opt_${idx}`,
          text: input ? input.value : '',
          imageUrl: baseOption.imageUrl || null,
          isCorrect: Boolean(radio?.checked)
        };
      });

      return { text, options };
    }

    async function saveQuestion(questionId, { showSuccess = true, showErrors = true } = {}) {
      if (!AppState.currentEditingQuiz) return;

      const draft = buildQuestionDraft(questionId);
      if (!draft) return;

      try {
        await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId)
          .update({
            text: draft.text,
            options: draft.options,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

        if (showSuccess) {
          showToast('Saved', 'success');
        }
      } catch (error) {
        console.error('[TEACHER] Failed to save question:', error);
        if (showErrors) {
          showToast('Failed to save question', 'error');
        }
        throw error;
      }
    }

    async function saveAllQuestions() {
      if (!AppState.currentQuestions.length) {
        showToast('No questions to save', 'warning');
        return;
      }

      try {
        await Promise.all(
          AppState.currentQuestions.map(question => saveQuestion(question.id, {
            showSuccess: false,
            showErrors: false
          }))
        );
        showToast('All questions saved', 'success');
      } catch (error) {
        console.error('[TEACHER] Failed to save all questions:', error);
        showToast('Failed to save all questions', 'error');
      }
    }

    async function deleteQuestion(questionId) {
      if (!confirm('Delete this question?')) return;

      try {
        await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId).delete();

        await loadQuestions(AppState.currentEditingQuiz);
        showToast('Question deleted', 'success');

      } catch (error) {
        console.error('[TEACHER] Failed to delete question:', error);
        showToast('Failed to delete question', 'error');
      }
    }

    function triggerImageUpload(type, id) {
      document.getElementById(`qimg_input_${id}`).click();
    }

    function triggerOptionImageUpload(questionId, optIdx) {
      document.getElementById(`optimg_${questionId}_${optIdx}`).click();
    }

    async function uploadQuestionImage(questionId, input) {
      if (!input.files[0]) return;

      const file = input.files[0];
      const progressBar = document.getElementById(`qimg_progress_${questionId}`);
      const progressFill = progressBar.querySelector('.progress-fill');

      progressBar.classList.remove('hidden');

      try {
        const storageRef = storage.ref(`quizzes/${AppState.currentEditingQuiz}/questions/${questionId}_${Date.now()}`);
        const uploadTask = storageRef.put(file);

        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progressFill.style.width = progress + '%';
          },
          (error) => {
            console.error('[UPLOAD] Error:', error);
            showToast('Upload failed', 'error');
            progressBar.classList.add('hidden');
          },
          async () => {
            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();

            await db.collection('quizzes').doc(AppState.currentEditingQuiz)
              .collection('questions').doc(questionId)
              .update({ imageUrl: downloadURL });

            progressBar.classList.add('hidden');
            showToast('Image uploaded', 'success');
            await loadQuestions(AppState.currentEditingQuiz);
          }
        );

      } catch (error) {
        console.error('[UPLOAD] Error:', error);
        showToast('Upload failed', 'error');
        progressBar.classList.add('hidden');
      }
    }

    async function uploadOptionImage(questionId, optIdx, input) {
      if (!input.files[0]) return;

      const file = input.files[0];

      try {
        showToast('Uploading...', 'info');

        const storageRef = storage.ref(`quizzes/${AppState.currentEditingQuiz}/options/${questionId}_opt${optIdx}_${Date.now()}`);
        const snapshot = await storageRef.put(file);
        const downloadURL = await snapshot.ref.getDownloadURL();

        // Get current question
        const doc = await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId).get();

        const options = doc.data().options || [];
        options[optIdx].imageUrl = downloadURL;

        await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId)
          .update({ options });

        showToast('Option image uploaded', 'success');
        await loadQuestions(AppState.currentEditingQuiz);

      } catch (error) {
        console.error('[UPLOAD] Option image error:', error);
        showToast('Upload failed', 'error');
      }
    }

    async function updateOption(questionId, optIdx, field, value) {
      try {
        const doc = await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId).get();

        const options = doc.data().options || [];

        if (field === 'isCorrect') {
          // Unset all others
          options.forEach((opt, i) => opt.isCorrect = (i === optIdx));
        } else {
          options[optIdx][field] = value;
        }

        await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId)
          .update({ options });

      } catch (error) {
        console.error('[TEACHER] Failed to update option:', error);
      }
    }

    async function addOption(questionId) {
      try {
        const doc = await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId).get();

        const options = doc.data().options || [];
        const letters = 'abcdefghij';
        options.push({
          id: letters[options.length] || `opt_${options.length}`,
          text: '',
          imageUrl: null,
          isCorrect: false
        });

        await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId)
          .update({ options });

        await loadQuestions(AppState.currentEditingQuiz);

      } catch (error) {
        console.error('[TEACHER] Failed to add option:', error);
      }
    }

    function closeQuestionEditor() {
      document.getElementById('questionEditorSection').classList.add('hidden');
      AppState.currentEditingQuiz = null;
    }

    async function deleteQuiz(quizId) {
      if (!confirm('Are you sure you want to delete this quiz and all its questions?')) return;

      try {
        // Delete questions subcollection first
        const questionsSnapshot = await db.collection('quizzes').doc(quizId).collection('questions').get();
        const batch = db.batch();
        questionsSnapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();

        // Delete quiz
        await db.collection('quizzes').doc(quizId).delete();

        showToast('Quiz deleted', 'success');
        await loadQuizzes();

      } catch (error) {
        console.error('[TEACHER] Failed to delete quiz:', error);
        showToast('Failed to delete quiz', 'error');
      }
    }

    // ============================================
    // PROCTORING
    // ============================================

    function setupTeacherListeners() {
      // Listen to authorized teachers
      const teacherUnsub = db.collection('authorized_teachers')
        .onSnapshot(snapshot => {
          AppState.teachers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          renderTeachersList();
        });

      AppState.unsubscribers.push(teacherUnsub);
    }

    function selectQuizForProctoring(quizId) {
      AppState.currentQuizId = quizId;

      // Clear existing listener
      if (AppState.sessionListener) {
        AppState.sessionListener();
      }

      updateInviteButton(quizId);

      // Update UI
      const quiz = AppState.quizzes.find(q => q.id === quizId);
      const banner = document.getElementById('quizStatusBanner');
      banner.classList.remove('hidden');

      if (quiz?.status === 'OPEN') {
        banner.style.background = 'rgba(72, 187, 120, 0.2)';
        banner.style.color = '#48bb78';
        banner.innerHTML = 'üü¢ Quiz is OPEN - Students can submit answers';
      } else {
        banner.style.background = 'rgba(245, 101, 101, 0.2)';
        banner.style.color = '#f56565';
        banner.innerHTML = 'üî¥ Quiz is CLOSED - Open it to allow submissions';
      }

      // Listen to sessions
      AppState.sessionListener = db.collection('sessions').doc(quizId)
        .collection('students')
        .onSnapshot(snapshot => {
          updateRoster(snapshot.docs);
        });

      AppState.unsubscribers.push(AppState.sessionListener);
    }

    function updateRoster(docs) {
      document.getElementById('studentCount').textContent = `${docs.length} Student${docs.length !== 1 ? 's' : ''}`;

      if (docs.length === 0) {
        document.getElementById('rosterBody').innerHTML = `
          <tr><td colspan="6" class="text-center text-muted">No students connected</td></tr>
        `;
        return;
      }

      document.getElementById('rosterBody').innerHTML = docs.map(doc => {
        const data = doc.data();
        const email = data.email || doc.id;
        const status = data.status || 'active';
        const violations = data.violations?.length || 0;
        const progress = data.progress || 0;
        const lastHeartbeat = data.lastHeartbeat;
        const isRecent = lastHeartbeat && (Date.now() - lastHeartbeat.toDate().getTime()) < 30000;

        return `
          <tr>
            <td>${email}</td>
            <td>
              <span class="status-badge ${isRecent ? 'active' : 'blocked'}">
                ${isRecent ? 'Connected' : 'Disconnected'}
              </span>
            </td>
            <td>
              <span class="status-badge ${status}">${status}</span>
            </td>
            <td>
              <div class="progress-bar" style="width: 100px; height: 6px;">
                <div class="progress-fill" style="width: ${progress}%"></div>
              </div>
              <span style="font-size: 11px; color: var(--gray);">${progress}%</span>
            </td>
            <td class="${violations > 0 ? 'text-danger' : ''}">${violations}</td>
            <td>
              ${status === 'blocked' ? `
                <button class="btn btn-sm btn-warning" onclick="unlockStudent('${doc.id}')">Unlock</button>
              ` : '-'}
            </td>
          </tr>
        `;
      }).join('');
    }

    async function unlockStudent(studentDocId) {
      if (!AppState.currentQuizId) return;

      try {
        await db.collection('sessions').doc(AppState.currentQuizId)
          .collection('students').doc(studentDocId)
          .update({
            status: 'active',
            unlockedAt: firebase.firestore.FieldValue.serverTimestamp(),
            unlockedBy: USER_EMAIL
          });

        showToast('Student unlocked', 'success');

      } catch (error) {
        console.error('[TEACHER] Failed to unlock student:', error);
        showToast('Failed to unlock student', 'error');
      }
    }

    async function toggleQuizStatus(status) {
      const quizId = document.getElementById('activeQuizSelect').value;
      if (!quizId) {
        showToast('Please select a quiz first', 'warning');
        return;
      }

      try {
        await db.collection('quizzes').doc(quizId).update({
          status,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Also update global state
        await db.collection('sys_admin').doc('global_state').set({
          activeQuizId: status === 'OPEN' ? quizId : null,
          status,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: USER_EMAIL
        }, { merge: true });

        if (status === 'OPEN') {
          await preseedRosterSessions(quizId);
        }

        showToast(`Quiz ${status === 'OPEN' ? 'opened' : 'closed'}`, 'success');
        await loadQuizzes();
        selectQuizForProctoring(quizId);

      } catch (error) {
        console.error('[TEACHER] Failed to update quiz status:', error);
        showToast('Failed to update quiz status', 'error');
      }
    }

    function getQuizRosterCourseId(quizId) {
      const quiz = AppState.quizzes.find(q => q.id === quizId);
      return quiz?.rosterCourseId || null;
    }

    function updateInviteButton(quizId) {
      const rosterCourseId = getQuizRosterCourseId(quizId);
      const btn = document.getElementById('sendInvitesBtn');
      if (!btn) return;
      btn.disabled = !rosterCourseId;
    }

    async function preseedRosterSessions(quizId) {
      const rosterCourseId = getQuizRosterCourseId(quizId);
      if (!rosterCourseId) return;

      try {
        const rosterSnapshot = await db.collection('courses').doc(rosterCourseId)
          .collection('roster').get();

        if (rosterSnapshot.empty) {
          return;
        }

        const sessionSnapshot = await db.collection('sessions').doc(quizId)
          .collection('students').get();
        const existingIds = new Set(sessionSnapshot.docs.map(doc => doc.id));

        const batch = db.batch();
        rosterSnapshot.docs.forEach(doc => {
          if (existingIds.has(doc.id)) return;
          const data = doc.data();
          const sessionRef = db.collection('sessions').doc(quizId)
            .collection('students').doc(doc.id);
          batch.set(sessionRef, {
            email: data.email || doc.id,
            name: data.name || '',
            block: data.block || '',
            status: 'invited',
            connectedAt: null,
            lastHeartbeat: null,
            violations: [],
            progress: 0
          }, { merge: true });
        });

        await batch.commit();
      } catch (error) {
        console.error('[TEACHER] Failed to preseed roster sessions:', error);
        showToast('Failed to preseed roster sessions', 'error');
      }
    }

    function sendInvitesForActiveQuiz() {
      const quizId = document.getElementById('activeQuizSelect').value;
      if (!quizId) {
        showToast('Please select a quiz first', 'warning');
        return;
      }

      const rosterCourseId = getQuizRosterCourseId(quizId);
      if (!rosterCourseId) {
        showToast('No roster attached to this quiz', 'warning');
        return;
      }

      showToast('Sending invites...', 'info');
      google.script.run
        .withSuccessHandler((result) => {
          if (result?.success) {
            showToast(`Invites sent: ${result.sent}`, 'success');
          } else {
            showToast('Failed to send invites', 'error');
          }
        })
        .withFailureHandler((error) => {
          console.error('[INVITES] Failed to send invites:', error);
          showToast('Failed to send invites', 'error');
        })
        .sendQuizInvites(quizId, rosterCourseId);
    }

    // ============================================
    // THE MATRIX (Analytics)
    // ============================================

    async function loadMatrixData(quizId) {
      try {
        const snapshot = await db.collection('responses').doc(quizId)
          .collection('students').get();

        const students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderMatrix(students);

      } catch (error) {
        console.error('[TEACHER] Failed to load matrix data:', error);
        showToast('Failed to load analytics', 'error');
      }
    }

    function renderMatrix(students) {
      // Clear quadrants
      document.getElementById('quadrantTL').innerHTML = '';
      document.getElementById('quadrantTR').innerHTML = '';
      document.getElementById('quadrantBL').innerHTML = '';
      document.getElementById('quadrantBR').innerHTML = '';

      let misconceptions = 0, mastery = 0, learning = 0, luckyGuess = 0;

      students.forEach(student => {
        const answers = student.answers || {};

        Object.values(answers).forEach(answer => {
          const isCorrect = answer.isCorrect;
          const confidence = answer.confidence || 2;
          const isHighConfidence = confidence >= 3;

          const dot = document.createElement('div');
          dot.className = 'student-dot';
          dot.title = `${student.email}\nAnswer: ${answer.answer}\nConfidence: ${confidence}\n${isCorrect ? 'Correct' : 'Incorrect'}`;

          if (!isCorrect && isHighConfidence) {
            // MISCONCEPTION - High confidence + Wrong
            dot.classList.add('misconception');
            document.getElementById('quadrantTL').appendChild(dot);
            misconceptions++;
          } else if (isCorrect && isHighConfidence) {
            // MASTERY - High confidence + Correct
            dot.classList.add('correct-confident');
            document.getElementById('quadrantTR').appendChild(dot);
            mastery++;
          } else if (!isCorrect && !isHighConfidence) {
            // LEARNING - Low confidence + Wrong
            dot.classList.add('incorrect-unsure');
            document.getElementById('quadrantBL').appendChild(dot);
            learning++;
          } else {
            // LUCKY GUESS - Low confidence + Correct
            dot.classList.add('correct-unsure');
            document.getElementById('quadrantBR').appendChild(dot);
            luckyGuess++;
          }
        });
      });

      const total = misconceptions + mastery + learning + luckyGuess;
      document.getElementById('matrixStats').innerHTML = `
        <strong>Total Responses:</strong> ${total}<br>
        <span class="text-danger">Misconceptions: ${misconceptions}</span> |
        <span class="text-success">Mastery: ${mastery}</span><br>
        <span class="text-warning">Learning: ${learning}</span> |
        <span style="color: var(--info)">Lucky Guess: ${luckyGuess}</span>
      `;
    }

    // ============================================
    // ADMIN PANEL
    // ============================================

    function renderTeachersList() {
      const tbody = document.getElementById('teachersList');

      if (AppState.teachers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No teachers found</td></tr>`;
        return;
      }

      tbody.innerHTML = AppState.teachers.map(teacher => `
        <tr>
          <td>${teacher.email || teacher.id}</td>
          <td>${teacher.displayName || '-'}</td>
          <td><span class="status-badge active">${teacher.role || 'teacher'}</span></td>
          <td class="text-muted">${formatTime(teacher.addedAt)}</td>
          <td>
            ${teacher.email !== USER_EMAIL ? `
              <button class="btn btn-sm btn-danger" onclick="removeTeacher('${teacher.id}')">Remove</button>
            ` : '<span class="text-muted">You</span>'}
          </td>
        </tr>
      `).join('');
    }

    async function addTeacher() {
      const email = document.getElementById('newTeacherEmail').value.trim().toLowerCase();

      if (!email || !email.includes('@')) {
        showToast('Please enter a valid email', 'warning');
        return;
      }

      try {
        await db.collection('authorized_teachers').doc(email).set({
          email,
          displayName: email.split('@')[0],
          role: 'teacher',
          addedBy: USER_EMAIL,
          addedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        document.getElementById('newTeacherEmail').value = '';
        showToast('Teacher added successfully', 'success');

      } catch (error) {
        console.error('[ADMIN] Failed to add teacher:', error);
        showToast('Failed to add teacher', 'error');
      }
    }

    async function createCourse() {
      const name = document.getElementById('newCourseName').value.trim();
      const block = document.getElementById('newCourseBlock').value.trim();

      if (!name) {
        showToast('Please enter a course name', 'warning');
        return;
      }

      try {
        await db.collection('courses').add({
          name,
          block,
          createdBy: USER_EMAIL,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          rosterCount: 0
        });

        document.getElementById('newCourseName').value = '';
        document.getElementById('newCourseBlock').value = '';
        showToast('Course created', 'success');
        await loadCourses();
      } catch (error) {
        console.error('[COURSES] Failed to create course:', error);
        showToast('Failed to create course', 'error');
      }
    }

    function parseRosterCsv(text) {
      return text
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0)
        .map(line => line.split(',').map(cell => cell.trim()))
        .filter(parts => parts[0]);
    }

    async function importRoster() {
      const courseId = document.getElementById('courseSelect').value;
      if (!courseId) {
        showToast('Please select a course', 'warning');
        return;
      }

      const rawCsv = document.getElementById('rosterCsvInput').value.trim();
      if (!rawCsv) {
        showToast('Paste roster CSV first', 'warning');
        return;
      }

      const rows = parseRosterCsv(rawCsv);
      if (rows.length === 0) {
        showToast('No valid roster rows found', 'warning');
        return;
      }

      try {
        const batch = db.batch();
        let validCount = 0;

        rows.forEach(([email, name = '', block = '']) => {
          const normalizedEmail = docIdFromEmail(email);
          if (!normalizedEmail || !normalizedEmail.includes('@')) {
            return;
          }

          const rosterRef = db.collection('courses').doc(courseId)
            .collection('roster').doc(normalizedEmail);

          batch.set(rosterRef, {
            email: normalizedEmail,
            name,
            block: block || '',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          validCount += 1;
        });

        if (validCount === 0) {
          showToast('No valid emails found', 'warning');
          return;
        }

        await batch.commit();

        const rosterSnapshot = await db.collection('courses').doc(courseId)
          .collection('roster').get();
        await db.collection('courses').doc(courseId).update({
          rosterCount: rosterSnapshot.size,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast(`Roster updated: ${validCount} students`, 'success');
        document.getElementById('rosterCsvInput').value = '';
        await loadCourses();
      } catch (error) {
        console.error('[COURSES] Failed to import roster:', error);
        showToast('Failed to import roster', 'error');
      }
    }

    async function removeTeacher(email) {
      if (email === USER_EMAIL) {
        showToast("You can't remove yourself", 'warning');
        return;
      }

      if (!confirm(`Remove ${email} from authorized teachers?`)) return;

      try {
        await db.collection('authorized_teachers').doc(email).delete();
        showToast('Teacher removed', 'success');

      } catch (error) {
        console.error('[ADMIN] Failed to remove teacher:', error);
        showToast('Failed to remove teacher', 'error');
      }
    }

    // ============================================
    // STUDENT EXAM VIEW
    // ============================================

    async function initializeStudentView() {
      console.log('[STUDENT] Initializing student view...');

      const inviteQuizId = getInviteQuizId();
      if (inviteQuizId) {
        setupInviteQuizListener(inviteQuizId);
      } else {
        // Listen to global state
        setupGlobalStateListener();
      }

      // Setup proctoring
      setupProctoring();
    }

    function getInviteQuizId() {
      const params = new URLSearchParams(window.location.search);
      const quizId = params.get('quiz');
      return quizId ? quizId.trim() : null;
    }

    function setupInviteQuizListener(quizId) {
      const unsub = db.collection('quizzes').doc(quizId)
        .onSnapshot(async (doc) => {
          if (!doc.exists) {
            showToast('Quiz not found', 'error');
            showScreen('waitingScreen');
            return;
          }

          const data = doc.data() || {};
          if (data.status === 'OPEN') {
            AppState.currentQuizId = quizId;
            await registerStudent();
            await loadExam(quizId);
          } else {
            showScreen('waitingScreen');
          }
        });

      AppState.unsubscribers.push(unsub);
    }

    function setupGlobalStateListener() {
      const unsub = db.collection('sys_admin').doc('global_state')
        .onSnapshot(async (doc) => {
          const data = doc.data() || {};
          console.log('[STUDENT] Global state update:', data);

          if (data.status === 'OPEN' && data.activeQuizId) {
            AppState.currentQuizId = data.activeQuizId;
            await registerStudent();
            await loadExam(data.activeQuizId);
          } else {
            showScreen('waitingScreen');
          }
        });

      AppState.unsubscribers.push(unsub);
    }

    async function registerStudent() {
      if (!AppState.currentQuizId) return;

      const studentDocId = docIdFromEmail(USER_EMAIL);

      try {
        const sessionRef = db.collection('sessions').doc(AppState.currentQuizId)
          .collection('students').doc(studentDocId);

        // Check existing session
        const doc = await sessionRef.get();

        if (doc.exists) {
          const data = doc.data();
          AppState.isBlocked = data.status === 'blocked';

          if (AppState.isBlocked) {
            showBlockedScreen();
            return;
          }

          if (data.status === 'invited') {
            await sessionRef.update({
              status: 'active',
              lastHeartbeat: firebase.firestore.FieldValue.serverTimestamp(),
              connectedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        } else {
          // Create new session
          await sessionRef.set({
            email: USER_EMAIL,
            status: 'active',
            connectedAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastHeartbeat: firebase.firestore.FieldValue.serverTimestamp(),
            violations: [],
            progress: 0
          });
        }

        // Listen to own status
        setupStudentStatusListener(studentDocId);

        // Start heartbeat
        startHeartbeat(studentDocId);

      } catch (error) {
        console.error('[STUDENT] Registration failed:', error);
      }
    }

    function setupStudentStatusListener(studentDocId) {
      const unsub = db.collection('sessions').doc(AppState.currentQuizId)
        .collection('students').doc(studentDocId)
        .onSnapshot((doc) => {
          if (!doc.exists) return;

          const data = doc.data();
          const wasBlocked = AppState.isBlocked;
          AppState.isBlocked = data.status === 'blocked';

          if (AppState.isBlocked && !wasBlocked) {
            showBlockedScreen();
          } else if (!AppState.isBlocked && wasBlocked) {
            hideBlockedScreen();
          }
        });

      AppState.unsubscribers.push(unsub);
    }

    function startHeartbeat(studentDocId) {
      setInterval(async () => {
        if (AppState.isBlocked || !AppState.currentQuizId) return;

        try {
          await db.collection('sessions').doc(AppState.currentQuizId)
            .collection('students').doc(studentDocId)
            .update({ lastHeartbeat: firebase.firestore.FieldValue.serverTimestamp() });
        } catch (error) {
          // Silent fail
        }
      }, 15000);
    }

    async function loadExam(quizId) {
      try {
        // Get quiz info
        const quizDoc = await db.collection('quizzes').doc(quizId).get();
        if (!quizDoc.exists) {
          showToast('Quiz not found', 'error');
          return;
        }

        const quiz = quizDoc.data();
        document.getElementById('quizBadge').textContent = quiz.title || 'Quiz';

        // Get questions
        const questionsSnapshot = await db.collection('quizzes').doc(quizId)
          .collection('questions').orderBy('order').get();

        AppState.questions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (AppState.questions.length === 0) {
          showToast('No questions in this quiz', 'warning');
          return;
        }

        // Check for existing responses
        const studentDocId = docIdFromEmail(USER_EMAIL);
        const responseDoc = await db.collection('responses').doc(quizId)
          .collection('students').doc(studentDocId).get();

        if (responseDoc.exists) {
          const responseData = responseDoc.data();
          AppState.answers = responseData.answers || {};

          // Check if completed
          const answeredCount = Object.keys(AppState.answers).length;
          if (answeredCount >= AppState.questions.length) {
            showCompletedScreen();
            return;
          }
        }

        // Show first unanswered question
        AppState.currentQuestionIndex = Object.keys(AppState.answers).length;
        renderCurrentQuestion();
        showScreen('examScreen');

      } catch (error) {
        console.error('[STUDENT] Failed to load exam:', error);
        showToast('Failed to load exam', 'error');
      }
    }

    function renderCurrentQuestion() {
      const question = AppState.questions[AppState.currentQuestionIndex];
      if (!question) {
        showCompletedScreen();
        return;
      }

      document.getElementById('questionCounter').textContent =
        `Question ${AppState.currentQuestionIndex + 1} of ${AppState.questions.length}`;

      document.getElementById('questionText').textContent = question.text || 'No question text';

      // Question image
      const questionImage = document.getElementById('questionImage');
      if (question.imageUrl) {
        questionImage.src = question.imageUrl;
        questionImage.classList.remove('hidden');
      } else {
        questionImage.classList.add('hidden');
      }

      // Shuffle options using Fisher-Yates
      const options = question.options || [];
      const shuffledOptions = fisherYatesShuffle(options);
      const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

      document.getElementById('optionsList').innerHTML = shuffledOptions.map((opt, idx) => `
        <button class="option-btn" onclick="selectAnswer(this, '${opt.id}', '${(opt.text || '').replace(/'/g, "\\'")}')">
          <span class="option-letter">${letters[idx]}</span>
          <div class="option-content">
            <span>${opt.text || 'Option'}</span>
            ${opt.imageUrl ? `<img src="${opt.imageUrl}" class="option-image">` : ''}
          </div>
        </button>
      `).join('');

      AppState.selectedAnswer = null;
    }

    function selectAnswer(buttonEl, optionId, optionText) {
      if (AppState.isBlocked) return;

      AppState.selectedAnswer = {
        id: optionId,
        text: optionText
      };

      // Update UI
      document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
      if (buttonEl) {
        buttonEl.classList.add('selected');
      }

      // Show metacognition modal
      document.getElementById('selectedAnswerPreview').textContent = optionText;
      AppState.selectedConfidence = null;
      document.querySelectorAll('.confidence-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('submitWithConfidenceBtn').disabled = true;
      DOM.metacognitionModal.classList.remove('hidden');
    }

    function selectConfidence(level) {
      AppState.selectedConfidence = level;
      document.querySelectorAll('.confidence-btn').forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.dataset.confidence) === level);
      });
      document.getElementById('submitWithConfidenceBtn').disabled = false;
    }

    function cancelMetacognition() {
      DOM.metacognitionModal.classList.add('hidden');
      AppState.selectedAnswer = null;
      document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
    }

    async function submitWithConfidence() {
      if (!AppState.selectedAnswer || !AppState.selectedConfidence || AppState.isBlocked) return;

      DOM.metacognitionModal.classList.add('hidden');

      const question = AppState.questions[AppState.currentQuestionIndex];
      const correctOption = question.options?.find(opt => opt.isCorrect);
      const isCorrect = correctOption?.id === AppState.selectedAnswer.id;

      const answerData = {
        questionId: question.id,
        answer: AppState.selectedAnswer.text,
        answerId: AppState.selectedAnswer.id,
        confidence: AppState.selectedConfidence,
        isCorrect,
        answeredAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        const studentDocId = docIdFromEmail(USER_EMAIL);
        const responseRef = db.collection('responses').doc(AppState.currentQuizId)
          .collection('students').doc(studentDocId);

        // Update response document
        await responseRef.set({
          email: USER_EMAIL,
          quizId: AppState.currentQuizId,
          [`answers.${question.id}`]: answerData,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // Update progress
        const progress = Math.round(((AppState.currentQuestionIndex + 1) / AppState.questions.length) * 100);
        await db.collection('sessions').doc(AppState.currentQuizId)
          .collection('students').doc(studentDocId)
          .update({ progress });

        // Store locally
        AppState.answers[question.id] = answerData;

        // Move to next question
        AppState.currentQuestionIndex++;

        if (AppState.currentQuestionIndex < AppState.questions.length) {
          renderCurrentQuestion();
        } else {
          showCompletedScreen();
        }

      } catch (error) {
        console.error('[STUDENT] Failed to submit answer:', error);

        if (error.code === 'permission-denied') {
          showBlockedScreen();
        } else {
          showToast('Failed to submit. Please try again.', 'error');
        }
      }
    }

    function showCompletedScreen() {
      const totalQuestions = AppState.questions.length;
      const correctCount = Object.values(AppState.answers).filter(a => a.isCorrect).length;

      document.getElementById('completionSummary').innerHTML = `
        <div style="font-size: 18px; margin-bottom: 10px;">
          <strong>Score: ${correctCount} / ${totalQuestions}</strong>
        </div>
        <div class="text-muted">
          Accuracy: ${Math.round((correctCount / totalQuestions) * 100)}%
        </div>
      `;

      showScreen('completedScreen');
    }

    // ============================================
    // PROCTORING
    // ============================================

    function setupProctoring() {
      document.addEventListener('visibilitychange', handleVisibilityChange);

      window.addEventListener('blur', () => {
        if (!AppState.isBlocked && AppState.currentQuizId && !AppState.hasSubmitted) {
          startViolationTimer();
        }
      });

      window.addEventListener('focus', clearViolationTimer);
    }

    function handleVisibilityChange() {
      if (IS_TEACHER || AppState.isBlocked || !AppState.currentQuizId) return;

      if (document.hidden) {
        startViolationTimer();
      } else {
        clearViolationTimer();
      }
    }

    function startViolationTimer() {
      if (AppState.tabSwitchTimer) return;

      AppState.tabSwitchTimer = setTimeout(async () => {
        await recordViolation();
      }, 1500);
    }

    function clearViolationTimer() {
      if (AppState.tabSwitchTimer) {
        clearTimeout(AppState.tabSwitchTimer);
        AppState.tabSwitchTimer = null;
      }
    }

    async function recordViolation() {
      if (!AppState.currentQuizId) return;

      const studentDocId = docIdFromEmail(USER_EMAIL);

      try {
        await db.collection('sessions').doc(AppState.currentQuizId)
          .collection('students').doc(studentDocId)
          .update({
            status: 'blocked',
            violations: firebase.firestore.FieldValue.arrayUnion({
              type: 'tab_switch',
              timestamp: new Date().toISOString()
            }),
            blockedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

        AppState.isBlocked = true;
        showBlockedScreen();

      } catch (error) {
        console.error('[PROCTOR] Failed to record violation:', error);
      }
    }

    function showBlockedScreen() {
      DOM.blockedScreen.classList.remove('hidden');
      DOM.app.classList.add('hidden');
      clearViolationTimer();
    }

    function hideBlockedScreen() {
      DOM.blockedScreen.classList.add('hidden');
      DOM.app.classList.remove('hidden');
    }

    // ============================================
    // CLEANUP
    // ============================================

    function cleanup() {
      clearViolationTimer();
      AppState.unsubscribers.forEach(unsub => {
        if (typeof unsub === 'function') unsub();
      });
    }

    window.addEventListener('beforeunload', cleanup);

    // ============================================
    // START APPLICATION
    // ============================================
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
