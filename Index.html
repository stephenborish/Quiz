<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Secure Assessment Platform - Real-time exam proctoring and analytics">
  <meta name="theme-color" content="#1a1a2e">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com;
    style-src 'self' 'unsafe-inline';
    img-src 'self' https: data: blob:;
    connect-src 'self' https://*.googleapis.com https://*.firebaseio.com wss://*.firebaseio.com https://www.gstatic.com https://*.firebaseapp.com wss://*.firebaseapp.com;
    font-src 'self' data:;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
  ">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <title>
    <?= appTitle ?>
  </title>

  <!-- ============================================
       EMBEDDED CSS STYLES
       ============================================ -->
  <style>
    /* ==========================================
       CSS VARIABLES & RESET
       ========================================== */
    :root {
      color-scheme: light;
      --primary: #667eea;
      --primary-dark: #5a67d8;
      --secondary: #764ba2;
      --success: #48bb78;
      --success-dark: #38a169;
      --danger: #f56565;
      --danger-dark: #e53e3e;
      --warning: #ed8936;
      --info: #4299e1;
      --dark: #f8fafc;
      --darker: #edf2f7;
      --darkest: #e2e8f0;
      --light: #1a202c;
      --gray: #4a5568;
      --gray-dark: #2d3748;
      --gray-light: #e2e8f0;
      --border-radius: 12px;
      --border-radius-lg: 20px;
      --shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.2);
      --transition: all 0.3s ease;
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      overflow: auto;
    }

    body {
      font-family: var(--font-family);
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: var(--light);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* ==========================================
       LAYOUT STRUCTURE
       ========================================== */
    .app-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: #ffffff;
      border-bottom: 1px solid var(--gray-light);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      z-index: 100;
      box-shadow: 0 2px 12px rgba(15, 23, 42, 0.06);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-logo {
      font-size: 22px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-version {
      font-size: 11px;
      color: var(--gray);
      background: #edf2f7;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .header-user {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-email {
      font-size: 13px;
      color: var(--gray);
    }

    .user-badge {
      padding: 5px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .user-badge.teacher {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
    }

    .user-badge.student {
      background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
      color: white;
    }

    .btn-logout {
      background: transparent;
      border: 1px solid var(--gray-light);
      color: var(--gray);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-logout:hover {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    .main-content {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* ==========================================
       TAB NAVIGATION (Teacher)
       ========================================== */
    .tab-nav {
      display: flex;
      background: #f1f5f9;
      padding: 0 20px;
      border-bottom: 1px solid var(--gray-light);
      overflow-x: auto;
      flex-shrink: 0;
    }

    .tab-btn {
      background: none;
      border: none;
      color: var(--gray);
      padding: 15px 25px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 3px solid transparent;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab-btn:hover {
      color: var(--gray-dark);
      background: #e2e8f0;
    }

    .tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: #e2e8f0;
    }

    .tab-icon {
      font-size: 16px;
    }

    .tab-content {
      flex: 1;
      overflow: hidden;
      position: relative;
      height: 100%;
      /* Ensure full height */
    }

    .tab-panel {
      display: none;
      height: 100%;
      overflow-y: auto;
      /* Scroll within panel */
      padding: 20px;
      padding-bottom: 80px;
      /* Space for bottom elements */
    }

    .tab-panel.active {
      display: block;
    }

    /* ==========================================
       CARDS & CONTAINERS
       ========================================== */
    .card {
      background: #ffffff;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-light);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
    }

    .card-actions {
      display: flex;
      gap: 10px;
    }

    /* ==========================================
       BUTTONS
       ========================================== */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(72, 187, 120, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(245, 101, 101, 0.4);
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid #cbd5e0;
      color: var(--gray-dark);
    }

    .btn-outline:hover {
      border-color: var(--primary);
      background: #edf2f7;
    }

    .btn-sm {
      padding: 6px 14px;
      font-size: 12px;
    }

    .btn-lg {
      padding: 15px 35px;
      font-size: 16px;
    }

    /* ==========================================
       FORMS
       ========================================== */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 16px;
      background: #ffffff;
      border: 2px solid #cbd5e0;
      border-radius: var(--border-radius);
      color: var(--gray-dark);
      font-size: 14px;
      transition: var(--transition);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: #ffffff;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-input::placeholder {
      color: var(--gray);
    }

    /* ==========================================
       TABLES
       ========================================== */
    .table-container {
      overflow-x: auto;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-light);
      background: #ffffff;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      background: #f8fafc;
      padding: 14px 16px;
      text-align: left;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray);
    }

    .data-table td {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 14px;
    }

    .data-table tr:hover {
      background: #f1f5f9;
    }

    /* ==========================================
       STATUS BADGES
       ========================================== */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-badge.active {
      background: rgba(72, 187, 120, 0.2);
      color: var(--success);
    }

    .status-badge.blocked {
      background: rgba(245, 101, 101, 0.2);
      color: var(--danger);
    }

    .status-badge.completed {
      background: rgba(66, 153, 225, 0.2);
      color: var(--info);
    }

    .status-badge.draft {
      background: rgba(160, 174, 192, 0.2);
      color: var(--gray);
    }

    .status-badge.open {
      background: rgba(72, 187, 120, 0.2);
      color: var(--success);
    }

    .status-badge.closed {
      background: rgba(245, 101, 101, 0.2);
      color: var(--danger);
    }

    /* ==========================================
       UPLOAD & PROGRESS
       ========================================== */
    .upload-zone {
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: var(--border-radius);
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .upload-zone:hover {
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.1);
    }

    .upload-zone.dragover {
      border-color: var(--success);
      background: rgba(72, 187, 120, 0.1);
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    .upload-text {
      color: var(--gray);
      font-size: 14px;
    }

    .progress-bar {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .image-preview {
      max-width: 200px;
      max-height: 150px;
      border-radius: var(--border-radius);
      margin-top: 10px;
    }

    /* ==========================================
       THE MATRIX (Analytics Grid)
       ========================================== */
    .matrix-container {
      display: flex;
      gap: 20px;
      height: calc(100% - 60px);
    }

    .matrix-grid {
      flex: 1;
      position: relative;
      background: rgba(0, 0, 0, 0.3);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255, 255, 255, 0.1);
      min-height: 400px;
    }

    .matrix-quadrant {
      position: absolute;
      width: 50%;
      height: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 10px;
    }

    .matrix-quadrant.top-left {
      top: 0;
      left: 0;
      background: rgba(237, 137, 54, 0.1);
    }

    .matrix-quadrant.top-right {
      top: 0;
      right: 0;
      background: rgba(72, 187, 120, 0.1);
    }

    .matrix-quadrant.bottom-left {
      bottom: 0;
      left: 0;
      background: rgba(245, 101, 101, 0.1);
    }

    .matrix-quadrant.bottom-right {
      bottom: 0;
      right: 0;
      background: rgba(66, 153, 225, 0.1);
    }

    .quadrant-label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.6;
      margin-bottom: 10px;
    }

    .quadrant-dots {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
    }

    .student-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }

    .student-dot:hover {
      transform: scale(1.5);
      z-index: 10;
    }

    .student-dot.misconception {
      background: var(--danger);
      animation: pulse-danger 1.5s infinite;
    }

    .student-dot.correct-confident {
      background: var(--success);
    }

    .student-dot.correct-unsure {
      background: var(--info);
    }

    .student-dot.incorrect-unsure {
      background: var(--warning);
    }

    @keyframes pulse-danger {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(245, 101, 101, 0.7);
      }

      50% {
        box-shadow: 0 0 0 8px rgba(245, 101, 101, 0);
      }
    }

    .matrix-legend {
      width: 250px;
      padding: 15px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: var(--border-radius);
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
    }

    .legend-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .legend-text {
      font-size: 12px;
    }

    .axis-label {
      position: absolute;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray);
    }

    .axis-label.x-axis {
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
    }

    .axis-label.y-axis {
      left: -35px;
      top: 50%;
      transform: rotate(-90deg) translateX(-50%);
      transform-origin: left center;
    }

    /* ==========================================
       STUDENT EXAM VIEW
       ========================================== */
    .screen {
      display: none;
      height: 100%;
    }

    .screen.active {
      display: flex;
      flex-direction: column;
    }

    .waiting-room {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 40px;
    }

    .waiting-icon {
      font-size: 80px;
      margin-bottom: 25px;
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-15px);
      }
    }

    .waiting-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .waiting-subtitle {
      font-size: 16px;
      color: var(--gray);
      max-width: 450px;
    }

    .waiting-status {
      margin-top: 30px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px 30px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 30px;
    }

    .pulse-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--warning);
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.5;
        transform: scale(0.8);
      }
    }

    /* Blocked Screen */
    .blocked-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #c0392b 0%, #6c1305 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      text-align: center;
      padding: 40px;
    }

    .blocked-icon {
      font-size: 100px;
      margin-bottom: 30px;
    }

    .blocked-title {
      font-size: 48px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 4px;
      margin-bottom: 20px;
    }

    .blocked-message {
      font-size: 18px;
      opacity: 0.9;
      max-width: 500px;
    }

    /* Exam Content */
    .exam-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 30px 20px;
      width: 100%;
    }

    .question-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius-lg);
      padding: 35px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .question-number {
      font-size: 13px;
      color: var(--gray);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .quiz-badge {
      background: var(--primary);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .question-text {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .question-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: var(--border-radius);
      margin-bottom: 25px;
    }

    .options-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .option-btn {
      background: #ffffff;
      border: 2px solid #e2e8f0;
      border-radius: var(--border-radius);
      padding: 16px 20px;
      color: var(--gray-dark);
      font-size: 15px;
      text-align: left;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .option-btn:hover {
      background: #f8fafc;
      border-color: var(--primary);
    }

    .option-btn.selected {
      background: rgba(102, 126, 234, 0.12);
      border-color: var(--primary);
    }

    .option-letter {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #edf2f7;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }

    .option-btn.selected .option-letter {
      background: var(--primary);
    }

    .option-content {
      flex: 1;
    }

    .option-image {
      max-width: 150px;
      max-height: 100px;
      border-radius: 8px;
      margin-top: 10px;
    }

    /* Metacognition Modal */
    .metacognition-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9000;
      padding: 20px;
    }

    .metacognition-content {
      background: #ffffff;
      border-radius: var(--border-radius-lg);
      padding: 40px;
      max-width: 500px;
      width: 100%;
      text-align: center;
      border: 1px solid var(--gray-light);
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.15);
    }

    .metacognition-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .metacognition-subtitle {
      font-size: 14px;
      color: var(--gray);
      margin-bottom: 30px;
    }

    .confidence-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 30px;
    }

    .confidence-btn {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: var(--border-radius);
      padding: 20px 15px;
      color: var(--gray-dark);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
    }

    .confidence-btn:hover {
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.1);
    }

    .confidence-btn.selected {
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.2);
    }

    .confidence-level {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 5px;
    }

    .confidence-label {
      font-size: 13px;
      color: var(--gray);
    }

    .metacognition-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .loading-overlay.error .spinner {
      display: none;
    }

    .loading-actions {
      display: none;
      gap: 12px;
      align-items: center;
    }

    .loading-overlay.error .loading-actions {
      display: flex;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      margin-top: 20px;
      font-size: 16px;
      color: var(--gray);
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
    }

    .toast {
      background: rgba(30, 30, 50, 0.95);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 15px 20px;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      animation: slideIn 0.3s ease;
      color: #fff;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.warning {
      border-left: 4px solid var(--warning);
    }

    /* ==========================================
       QUIZ BUILDER SPLIT VIEW
       ========================================== */
    .split-view {
      display: flex;
      height: 100%;
      overflow: hidden;
    }

    .editor-sidebar {
      width: 300px;
      border-right: 1px solid var(--gray-light);
      background: #fff;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid var(--gray-light);
      background: #f8fafc;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .editor-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f8fafc;
      overflow: hidden;
    }

    .editor-toolbar {
      padding: 15px 25px;
      background: #fff;
      border-bottom: 1px solid var(--gray-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .editor-scroll-area {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
    }

    .question-list-item {
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
      background: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .question-list-item:hover {
      background: #edf2f7;
    }

    .question-list-item.active {
      background: #ebf4ff;
      border-color: var(--primary);
      color: var(--primary-dark);
      font-weight: 500;
    }

    .question-card {
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 30px;
      max-width: 800px;
      margin: 0 auto;
    }

    /* Option Editor Styling */
    .option-editor {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 12px;
      padding: 18px;
      background: #f8fafc;
      border-radius: var(--border-radius);
      border: 1px solid #e2e8f0;
      transition: var(--transition);
    }

    .option-editor:focus-within {
      background: #fff;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .quiz-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .quiz-card {
      background: #ffffff;
      border-radius: var(--border-radius);
      padding: 20px;
      border: 1px solid var(--gray-light);
      transition: var(--transition);
    }

    .quiz-card:hover {
      border-color: var(--primary);
      transform: translateY(-3px);
    }

    .quiz-card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .quiz-card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
    }

    .question-count {
      font-size: 13px;
      color: var(--gray);
    }

    .question-editor {
      background: #f8fafc;
      border-radius: var(--border-radius);
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid var(--gray-light);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .option-editor {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 12px;
      padding: 18px;
      background: #ffffff;
      border-radius: var(--border-radius);
      border: 1px solid #e2e8f0;
      transition: var(--transition);
    }

    .option-editor:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    #questionsList {
      max-height: 60vh;
      overflow-y: scroll;
      padding-right: 6px;
      scrollbar-width: auto;
      scrollbar-color: #cbd5e0 #edf2f7;
    }

    #questionsList::-webkit-scrollbar {
      width: 12px;
    }

    #questionsList::-webkit-scrollbar-track {
      background: #edf2f7;
      border-radius: 10px;
    }

    #questionsList::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 10px;
      border: 3px solid #edf2f7;
    }

    #questionsList::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
    }

    .option-editor .form-input {
      flex: 1;
    }

    .correct-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .correct-checkbox input {
      width: 18px;
      height: 18px;
      accent-color: var(--success);
    }

    /* ==========================================
       RESPONSIVE DESIGN
       ========================================== */
    @media (max-width: 768px) {
      .header {
        padding: 10px 15px;
      }

      .header-logo {
        font-size: 18px;
      }

      .header-version {
        display: none;
      }

      .tab-btn {
        padding: 12px 15px;
        font-size: 13px;
      }

      .tab-btn span:not(.tab-icon) {
        display: none;
      }

      .matrix-container {
        flex-direction: column;
      }

      .matrix-legend {
        width: 100%;
      }

      .question-text {
        font-size: 18px;
      }

      .confidence-options {
        grid-template-columns: 1fr;
      }
    }

    /* ==========================================
       UTILITY CLASSES
       ========================================== */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .text-success {
      color: var(--success);
    }

    .text-danger {
      color: var(--danger);
    }

    .text-warning {
      color: var(--warning);
    }

    .text-muted {
      color: var(--gray);
    }

    .mt-10 {
      margin-top: 10px;
    }

    .mt-20 {
      margin-top: 20px;
    }

    .mb-10 {
      margin-bottom: 10px;
    }

    .mb-20 {
      margin-bottom: 20px;
    }

    .flex {
      display: flex;
    }

    .flex-center {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gap-10 {
      gap: 10px;
    }

    .gap-20 {
      gap: 20px;
    }
  </style>
</head>

<body>
  <!-- Debug script - runs first to verify JS execution -->
  <script>
    console.log('[DEBUG] Script execution test - if you see this, inline scripts work');
    window.SCRIPT_EXECUTION_VERIFIED = true;
  </script>

  <!-- ============================================
       LOADING OVERLAY
       ============================================ -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">Initializing Secure Assessment Platform...</div>
    <div class="loading-actions">
      <button class="btn btn-outline" onclick="location.reload()">Retry</button>
      <a id="openAppLink" class="btn btn-outline" target="_blank" rel="noopener">Open in new tab</a>
    </div>
  </div>

  <!-- ============================================
       BLOCKED SCREEN (Students Only)
       ============================================ -->
  <div id="blockedScreen" class="blocked-screen hidden">
    <div class="blocked-icon">üö´</div>
    <h1 class="blocked-title">Session Locked</h1>
    <p class="blocked-message">
      A tab switch or window change was detected.<br><br>
      Please see your teacher to continue.
    </p>
  </div>

  <!-- ============================================
       MAIN APPLICATION
       ============================================ -->
  <div id="app" class="app-container hidden">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <h1 class="header-logo">Secure Assessment</h1>
        <span class="header-version">v
          <?= appVersion ?>
        </span>
      </div>
      <div class="header-user">
        <span class="user-email">
          <?= userEmail ?>
        </span>
        <span id="userBadge" class="user-badge <?= isTeacher ? 'teacher' : 'student' ?>">
          <?= userRole ?>
        </span>
        <button id="logoutBtn" class="btn-logout" onclick="logout()" title="Sign out">
          üö™ Logout
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- ==========================================
           TEACHER COMMAND CENTER
           ========================================== -->
      <div id="teacherView" class="<?= isTeacher ? '' : 'hidden' ?>">
        <!-- Tab Navigation -->
        <nav class="tab-nav">
          <button class="tab-btn active" data-tab="proctoring">
            <span class="tab-icon">üëÅÔ∏è</span>
            <span>Live Proctoring</span>
          </button>
          <button class="tab-btn" data-tab="builder">
            <span class="tab-icon">üìù</span>
            <span>Quiz Builder</span>
          </button>
          <button class="tab-btn" data-tab="matrix">
            <span class="tab-icon">üìä</span>
            <span>The Matrix</span>
          </button>
          <button class="tab-btn" data-tab="admin">
            <span class="tab-icon">‚öôÔ∏è</span>
            <span>Admin Panel</span>
          </button>
        </nav>

        <!-- Tab Content -->
        <div class="tab-content">
          <!-- Live Proctoring Panel -->
          <div id="proctoringPanel" class="tab-panel active">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Quiz Control</h2>
                <div class="card-actions">
                  <select id="activeQuizSelect" class="form-select" style="width: 200px;">
                    <option value="">Select Quiz...</option>
                  </select>
                  <button id="openQuizBtn" class="btn btn-success" onclick="toggleQuizStatus('OPEN')">
                    Open Quiz
                  </button>
                  <button id="closeQuizBtn" class="btn btn-danger" onclick="toggleQuizStatus('CLOSED')">
                    Close Quiz
                  </button>
                  <button id="sendInvitesBtn" class="btn btn-outline" onclick="sendInvitesForActiveQuiz()" disabled>
                    Send Invites
                  </button>
                </div>
              </div>
              <div id="quizStatusBanner" class="hidden"
                style="padding: 15px; border-radius: 8px; text-align: center; font-weight: 600;"></div>
            </div>

            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Live Student Roster</h2>
                <span id="studentCount" class="status-badge active">0 Students</span>
              </div>
              <div class="table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Student Email</th>
                      <th>Connection</th>
                      <th>Status</th>
                      <th>Progress</th>
                      <th>Violations</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="rosterBody">
                    <tr>
                      <td colspan="6" class="text-center text-muted">No students connected</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Quiz Builder Panel -->
          <div id="builderPanel" class="tab-panel">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Your Quizzes</h2>
                <button class="btn btn-primary" onclick="showCreateQuizModal()">
                  + Create New Quiz
                </button>
              </div>
              <div id="quizList" class="quiz-list">
                <!-- Populated by JavaScript -->
              </div>
            </div>

            <!-- Question Editor (Hidden by default) -->
            <!-- Split View Editor (Hidden by default) -->
            <div id="quizEditorView" class="hidden" style="height: 100%; display: none; flex-direction: column;">
              <header class="editor-toolbar">
                <div class="flex items-center gap-10">
                  <button class="btn btn-outline btn-sm" onclick="closeQuizEditor()">‚Üê Back</button>
                  <h2 id="editingQuizTitle" class="text-lg font-bold">Quiz Title</h2>
                </div>
                <div class="flex items-center gap-10">
                  <span id="saveStatus" class="text-sm text-muted">All changes saved</span>
                  <!-- <button class="btn btn-primary btn-sm" onclick="saveCurrentQuestion()">Save</button> -->
                </div>
              </header>

              <div class="split-view">
                <!-- Sidebar: Question List -->
                <aside class="editor-sidebar">
                  <div class="sidebar-header flex justify-between items-center">
                    <h3 class="font-bold text-sm text-gray-600 uppercase">Questions</h3>
                    <button class="btn btn-sm btn-outline" onclick="addNewQuestion()">+ Add</button>
                  </div>
                  <div id="questionsSidebarList" class="sidebar-content">
                    <!-- Populated by JS -->
                  </div>
                </aside>

                <!-- Main: Editor -->
                <main class="editor-main">
                  <div id="questionEditorArea" class="editor-scroll-area">
                    <div id="emptyEditorState" class="flex flex-col items-center justify-center h-full text-muted">
                      <div class="text-4xl mb-4">üëà</div>
                      <p>Select a question from the left to edit</p>
                    </div>

                    <div id="activeQuestionEditor" class="hidden">
                      <!-- Dynamic Form Injected Here -->
                    </div>
                  </div>
                </main>
              </div>
            </div>
          </div>

          <!-- The Matrix (Analytics) Panel -->
          <div id="matrixPanel" class="tab-panel">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">The Metacognition Matrix</h2>
                <select id="matrixQuizSelect" class="form-select" style="width: 200px;">
                  <option value="">Select Quiz...</option>
                </select>
              </div>

              <div class="matrix-container">
                <div class="matrix-grid">
                  <span class="axis-label y-axis">CONFIDENCE</span>
                  <span class="axis-label x-axis">ACCURACY</span>

                  <!-- Top Left: High Confidence / Incorrect = MISCONCEPTION -->
                  <div class="matrix-quadrant top-left">
                    <div class="quadrant-label" style="color: var(--danger);">Active Misconception</div>
                    <div id="quadrantTL" class="quadrant-dots"></div>
                  </div>

                  <!-- Top Right: High Confidence / Correct = MASTERY -->
                  <div class="matrix-quadrant top-right">
                    <div class="quadrant-label" style="color: var(--success);">Mastery</div>
                    <div id="quadrantTR" class="quadrant-dots"></div>
                  </div>

                  <!-- Bottom Left: Low Confidence / Incorrect = LEARNING -->
                  <div class="matrix-quadrant bottom-left">
                    <div class="quadrant-label" style="color: var(--warning);">Learning</div>
                    <div id="quadrantBL" class="quadrant-dots"></div>
                  </div>

                  <!-- Bottom Right: Low Confidence / Correct = LUCKY GUESS -->
                  <div class="matrix-quadrant bottom-right">
                    <div class="quadrant-label" style="color: var(--info);">Lucky Guess</div>
                    <div id="quadrantBR" class="quadrant-dots"></div>
                  </div>
                </div>

                <div class="matrix-legend">
                  <h3 style="font-size: 14px; margin-bottom: 15px; color: var(--gray);">LEGEND</h3>

                  <div class="legend-item" style="background: rgba(245, 101, 101, 0.2);">
                    <div class="legend-dot" style="background: var(--danger);"></div>
                    <div class="legend-text">
                      <strong style="color: var(--danger);">Active Misconception</strong><br>
                      <span class="text-muted">High confidence + Wrong</span>
                    </div>
                  </div>

                  <div class="legend-item" style="background: rgba(72, 187, 120, 0.2);">
                    <div class="legend-dot" style="background: var(--success);"></div>
                    <div class="legend-text">
                      <strong style="color: var(--success);">Mastery</strong><br>
                      <span class="text-muted">High confidence + Correct</span>
                    </div>
                  </div>

                  <div class="legend-item" style="background: rgba(237, 137, 54, 0.2);">
                    <div class="legend-dot" style="background: var(--warning);"></div>
                    <div class="legend-text">
                      <strong style="color: var(--warning);">Learning</strong><br>
                      <span class="text-muted">Low confidence + Wrong</span>
                    </div>
                  </div>

                  <div class="legend-item" style="background: rgba(66, 153, 225, 0.2);">
                    <div class="legend-dot" style="background: var(--info);"></div>
                    <div class="legend-text">
                      <strong style="color: var(--info);">Lucky Guess</strong><br>
                      <span class="text-muted">Low confidence + Correct</span>
                    </div>
                  </div>

                  <div class="mt-20">
                    <div id="matrixStats" class="text-muted" style="font-size: 13px;">
                      Select a quiz to view analytics
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Admin Panel -->
          <div id="adminPanel" class="tab-panel">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Rosters (Courses)</h2>
              </div>

              <div class="form-group">
                <label class="form-label">Create Course</label>
                <div class="flex gap-10">
                  <input type="text" id="newCourseName" class="form-input" placeholder="Course name" style="flex: 2;">
                  <input type="text" id="newCourseBlock" class="form-input" placeholder="Block" style="flex: 1;">
                  <button class="btn btn-success" onclick="createCourse()">Create</button>
                </div>
              </div>

              <div class="form-group mt-20">
                <label class="form-label">Manage Courses</label>
                <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Block</th>
                        <th>Students</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="coursesListBody">
                      <tr>
                        <td colspan="4" class="text-center text-muted">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Select Course</label>
                <select id="courseSelect" class="form-select">
                  <option value="">Select course...</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">Import Roster CSV (email,name,block)</label>
                <textarea id="rosterCsvInput" class="form-textarea"
                  placeholder="student1@example.com,Student One,A&#10;student2@example.com,Student Two,B"></textarea>
                <div class="mt-10">
                  <button class="btn btn-primary" onclick="importRoster()">Import / Update Roster</button>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Authorized Teachers</h2>
              </div>

              <div class="form-group">
                <label class="form-label">Add New Teacher</label>
                <div class="flex gap-10">
                  <input type="email" id="newTeacherEmail" class="form-input" placeholder="teacher@school.edu"
                    style="flex: 1;">
                  <button class="btn btn-success" onclick="addTeacher()">Add Teacher</button>
                </div>
              </div>

              <div class="table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Email</th>
                      <th>Display Name</th>
                      <th>Role</th>
                      <th>Added</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="teachersList">
                    <tr>
                      <td colspan="5" class="text-center text-muted">Loading teachers...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==========================================
           STUDENT EXAM VIEW
           ========================================== -->
      <div id="studentView" class="<?= isTeacher ? 'hidden' : '' ?>" style="height: 100%;">
        <!-- Waiting Room -->
        <div id="waitingScreen" class="screen active">
          <div class="waiting-room">
            <div class="waiting-icon">‚è≥</div>
            <h1 class="waiting-title">Waiting Room</h1>
            <p class="waiting-subtitle">
              Your teacher is preparing the assessment. Please wait here and keep this tab focused.
            </p>
            <div class="waiting-status">
              <div class="pulse-dot"></div>
              <span>Waiting for quiz to open...</span>
            </div>
          </div>
        </div>

        <!-- Exam Screen -->
        <div id="examScreen" class="screen">
          <div class="exam-container">
            <div class="question-card">
              <div class="question-header">
                <span id="questionCounter" class="question-number">Question 1 of 1</span>
                <span id="quizBadge" class="quiz-badge">Quiz</span>
              </div>

              <h2 id="questionText" class="question-text">Loading question...</h2>
              <img id="questionImage" class="question-image hidden" src="" alt="Question image">

              <div id="optionsList" class="options-list">
                <!-- Populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>

        <!-- Completed Screen -->
        <div id="completedScreen" class="screen">
          <div class="waiting-room">
            <div class="waiting-icon">‚úÖ</div>
            <h1 class="waiting-title" style="color: var(--success);">Assessment Complete!</h1>
            <p class="waiting-subtitle">
              Your responses have been recorded. Please wait for your teacher's instructions.
            </p>
            <div id="completionSummary" class="mt-20"
              style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
              <!-- Summary populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ============================================
       METACOGNITION MODAL
       ============================================ -->
  <div id="metacognitionModal" class="metacognition-modal hidden">
    <div class="metacognition-content">
      <h2 class="metacognition-title">How confident are you?</h2>
      <p class="metacognition-subtitle">
        Your answer: <strong id="selectedAnswerPreview">...</strong>
      </p>

      <div class="confidence-options">
        <button class="confidence-btn" data-confidence="1" onclick="selectConfidence(1)">
          <div class="confidence-level">1</div>
          <div class="confidence-label">Guessed</div>
        </button>
        <button class="confidence-btn" data-confidence="2" onclick="selectConfidence(2)">
          <div class="confidence-level">2</div>
          <div class="confidence-label">Unsure</div>
        </button>
        <button class="confidence-btn" data-confidence="3" onclick="selectConfidence(3)">
          <div class="confidence-level">3</div>
          <div class="confidence-label">Confident</div>
        </button>
        <button class="confidence-btn" data-confidence="4" onclick="selectConfidence(4)">
          <div class="confidence-level">4</div>
          <div class="confidence-label">Certain</div>
        </button>
      </div>

      <div class="metacognition-actions">
        <button class="btn btn-outline" onclick="cancelMetacognition()">Change Answer</button>
        <button id="submitWithConfidenceBtn" class="btn btn-success" onclick="submitWithConfidence()" disabled>
          Submit Answer
        </button>
      </div>
    </div>
  </div>

  <!-- ============================================
       CREATE QUIZ MODAL
       ============================================ -->
  <div id="createQuizModal" class="metacognition-modal hidden">
    <div class="metacognition-content">
      <h2 class="metacognition-title">Create New Quiz</h2>

      <div class="form-group">
        <label class="form-label">Quiz Title</label>
        <input type="text" id="newQuizTitle" class="form-input" placeholder="e.g., Chapter 5 Review">
      </div>

      <div class="form-group">
        <label class="form-label">Description (optional)</label>
        <textarea id="newQuizDescription" class="form-textarea" placeholder="Brief description..."></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Attach Roster (optional)</label>
        <select id="newQuizRosterSelect" class="form-select">
          <option value="">No roster</option>
        </select>
      </div>

      <div class="metacognition-actions">
        <button class="btn btn-outline" onclick="closeCreateQuizModal()">Cancel</button>
        <button class="btn btn-success" onclick="createNewQuiz()">Create Quiz</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- ============================================
       FIREBASE SDK (Compat 9.22.0)
       ============================================ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <!-- ============================================
       MAIN APPLICATION JAVASCRIPT
       ============================================ -->
  <script>
    // ============================================
    // SCRIPT START - Debug marker
    // ============================================
    console.log('[SCRIPT] Main script starting...');

    // ============================================
    // SERVER-INJECTED VARIABLES (TRUSTED)
    // ============================================
    const USER_EMAIL = '<?= userEmail ?>';
    const IS_TEACHER = <?= isTeacher ?>;
    const USER_ROLE = '<?= userRole ?>';
    const APP_URL = '<?= appUrl ?>';
    const AUTH_TOKEN = '<?= authToken ?>';
    const AUTH_TOKEN_ERROR = '<?= authTokenError ?>';

    // ============================================
    // CONFIGURATION (must be before any logger usage)
    // ============================================
    const DEBUG_MODE = false; // Set to false in production

    // Safe console logging
    const logger = {
      log: (...args) => DEBUG_MODE && console.log(...args),
      warn: (...args) => console.warn(...args), // Always show warnings
      error: (...args) => console.error(...args), // Always show errors
      info: (...args) => DEBUG_MODE && console.info(...args)
    };

    // Parse Firebase config safely
    let FIREBASE_CONFIG = null;
    try {
      FIREBASE_CONFIG = <?!= firebaseConfig ?>;
      console.log('[SCRIPT] Firebase config parsed successfully');
    } catch (configError) {
      logger.error('[SCRIPT] Firebase config parse error:', configError);
    }

    logger.log('[SCRIPT] Variables injected. USER_EMAIL:', USER_EMAIL, 'IS_TEACHER:', IS_TEACHER);
    logger.log('[SCRIPT] AUTH_TOKEN exists:', !!AUTH_TOKEN && AUTH_TOKEN !== '' && AUTH_TOKEN !== 'null');
    logger.log('[SCRIPT] AUTH_TOKEN_ERROR:', AUTH_TOKEN_ERROR || '(none)');
    logger.log('[SCRIPT] FIREBASE_CONFIG valid:', !!FIREBASE_CONFIG && !!FIREBASE_CONFIG.apiKey);

    // ============================================
    // INITIALIZE FIREBASE
    // ============================================
    let db = null;
    let storage = null;
    let firebaseInitError = null;

    try {
      // Check if Firebase SDK loaded
      if (typeof firebase === 'undefined') {
        throw new Error('Firebase SDK not loaded. Check network connectivity.');
      }

      if (!FIREBASE_CONFIG || !FIREBASE_CONFIG.apiKey) {
        throw new Error('Missing Firebase configuration.');
      }

      console.log('[FIREBASE] Initializing with project:', FIREBASE_CONFIG.projectId);
      firebase.initializeApp(FIREBASE_CONFIG);
      db = firebase.firestore();
      storage = firebase.storage();
      logger.log('[FIREBASE] Initialized successfully');
    } catch (error) {
      logger.error('[FIREBASE] Initialization failed:', error);
      firebaseInitError = error;
    }

    // ============================================
    // APPLICATION STATE
    // ============================================
    const AppState = {
      // Common
      currentQuizId: null,
      unsubscribers: [],

      // Teacher
      quizzes: [],
      currentEditingQuiz: null,
      currentQuestions: [],
      courses: [],
      selectedCourseId: null,
      teachers: [],

      // Student
      isBlocked: false,
      currentQuestion: null,
      questions: [],
      currentQuestionIndex: 0,
      selectedAnswer: null,
      selectedConfidence: null,
      hasSubmitted: false,
      tabSwitchTimer: null,
      answers: {},
      heartbeatIntervalId: null
    };

    // ============================================
    // DOM REFERENCES
    // ============================================
    const DOM = {
      loadingOverlay: document.getElementById('loadingOverlay'),
      blockedScreen: document.getElementById('blockedScreen'),
      app: document.getElementById('app'),
      teacherView: document.getElementById('teacherView'),
      studentView: document.getElementById('studentView'),
      metacognitionModal: document.getElementById('metacognitionModal'),
      createQuizModal: document.getElementById('createQuizModal'),
      toastContainer: document.getElementById('toastContainer')
    };

    async function initializeApp() {
      console.log('[INIT] initializeApp started');
      try {
        if (firebaseInitError) {
          console.error('[INIT] Firebase failed to load:', firebaseInitError);
          showToast('System Error: Firebase unavailable', 'error');
          return;
        }

        // Validate Auth Token
        if (!AUTH_TOKEN || AUTH_TOKEN === 'null' || AUTH_TOKEN === '') {
          console.error('[INIT] Invalid Auth Token');
          if (AUTH_TOKEN_ERROR) console.error('[INIT] Auth Token Error:', AUTH_TOKEN_ERROR);
          showToast('Authentication Error: Please refresh', 'error');
          return;
        }

        console.log('[INIT] Authenticating with Firebase...');
        await firebase.auth().signInWithCustomToken(AUTH_TOKEN);
        console.log('[INIT] Firebase Auth successful');

        // Check Teacher Status
        if (IS_TEACHER) {
          console.log('[INIT] User verified as TEACHER');
          await setupTeacherDashboard();
        } else {
          console.log('[INIT] User identified as STUDENT');
          await setupStudentView();
        }

        console.log('[INIT] Removing loading screen...');
        DOM.loadingOverlay.classList.add('hidden');
        console.log('[INIT] Loading screen removed');

      } catch (error) {
        console.error('[INIT] Critical Initialization Error:', error);
        showToast('Initialization Failed: ' + error.message, 'error');
        // Do not hide loading screen on critical error to prevent broken UI usage
      }
    }

    /**
     * Sanitize URL to prevent javascript: protocol and XSS
     */
    function sanitizeURL(url) {
      if (!url) return '';
      const trimmed = url.trim().toLowerCase();
      if (trimmed.startsWith('javascript:') ||
        trimmed.startsWith('data:') ||
        trimmed.startsWith('vbscript:')) {
        return '';
      }
      return url;
    }

    /**
     * Validate email format
     */
    function isValidEmail(email) {
      if (!email) return false;
      const trimmed = email.trim();
      // RFC 5322 simplified regex
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(trimmed);
    }

    /**
     * Show toast notification (XSS-safe)
     */
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icon = document.createElement('span');
      icon.style.fontSize = '18px';
      icon.textContent = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';

      const text = document.createElement('span');
      text.textContent = message;

      toast.appendChild(icon);
      toast.appendChild(text);
      DOM.toastContainer.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    /**
     * Show/hide screens
     */
    function showScreen(screenId) {
      const screens = ['waitingScreen', 'examScreen', 'completedScreen'];
      screens.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.toggle('active', id === screenId);
        }
      });
    }

    /**
     * Format timestamp
     */
    function formatTime(timestamp) {
      if (!timestamp) return 'N/A';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleString();
    }

    /**
     * Monitor session timeout and warn user
     * Firebase custom tokens expire after 1 hour
     */
    function startSessionTimeoutMonitor() {
      const sessionDuration = 60 * 60 * 1000; // 1 hour
      const warningTime = 55 * 60 * 1000; // Warn at 55 minutes

      // Warning before expiration
      setTimeout(() => {
        showToast('Your session will expire in 5 minutes. Please save your work.', 'warning');

        // Show another warning at 58 minutes
        setTimeout(() => {
          showToast('Your session will expire in 2 minutes. Please save your work now.', 'warning');
        }, 3 * 60 * 1000);

      }, warningTime);

      // Auto-logout at expiration
      setTimeout(() => {
        showToast('Session expired. Reloading...', 'error');
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      }, sessionDuration);
    }

    /**
     * Logout function with proper cleanup
     */
    async function logout() {
      if (!confirm('Are you sure you want to sign out?')) {
        return;
      }

      try {
        // Show loading state
        DOM.loadingOverlay.classList.remove('hidden');

        // Unsubscribe from all Firestore listeners
        AppState.unsubscribers.forEach(unsubscribe => {
          try {
            unsubscribe();
          } catch (e) {
            console.error('[LOGOUT] Failed to unsubscribe:', e);
          }
        });
        AppState.unsubscribers = [];

        // Clear timers
        if (AppState.tabSwitchTimer) {
          clearTimeout(AppState.tabSwitchTimer);
          AppState.tabSwitchTimer = null;
        }

        // Sign out from Firebase
        await firebase.auth().signOut();

        // Clear application state
        Object.keys(AppState).forEach(key => {
          if (Array.isArray(AppState[key])) {
            AppState[key] = [];
          } else if (typeof AppState[key] === 'object' && AppState[key] !== null) {
            AppState[key] = {};
          } else {
            AppState[key] = null;
          }
        });

        // Reload the page to return to authentication
        window.location.reload();

      } catch (error) {
        console.error('[LOGOUT] Logout failed:', error);
        showToast('Logout failed. Please try again.', 'error');
        DOM.loadingOverlay.classList.add('hidden');
      }
    }

    // ============================================
    // INITIALIZATION
    // ============================================

    function failInitialization(message) {
      stopInitWatchdog();
      DOM.loadingOverlay.classList.add('error');
      const loadingText = document.getElementById('loadingText');
      if (loadingText) {
        loadingText.textContent = message || 'Initialization failed. Please try again.';
      }
      showToast(message || 'Initialization failed', 'error');
    }

    function setLoadingStatus(message) {
      const loadingText = document.getElementById('loadingText');
      if (loadingText) {
        loadingText.textContent = message;
      }
    }

    let initWatchdog = null;

    function startInitWatchdog(timeoutMs) {
      if (initWatchdog) {
        clearTimeout(initWatchdog);
      }
      initWatchdog = setTimeout(() => {
        if (!DOM.loadingOverlay.classList.contains('hidden')) {
          failInitialization('Initialization is taking longer than expected. Please retry.');
        }
      }, timeoutMs);
    }

    function stopInitWatchdog() {
      if (initWatchdog) {
        clearTimeout(initWatchdog);
        initWatchdog = null;
      }
    }

    function withTimeout(promise, timeoutMs, timeoutMessage) {
      return Promise.race([
        promise,
        new Promise((_, reject) => setTimeout(() => reject(new Error(timeoutMessage)), timeoutMs))
      ]);
    }

    async function initializeApp() {
      console.log('[INIT] Starting application initialization...');

      try {
        const openAppLink = document.getElementById('openAppLink');
        if (openAppLink) {
          openAppLink.href = APP_URL || window.location.href;
        }
        startInitWatchdog(25000);
        setLoadingStatus('Preparing configuration...');

        // Check for Firebase initialization errors first
        if (firebaseInitError) {
          failInitialization('Firebase error: ' + firebaseInitError.message);
          return;
        }

        if (!db || !storage) {
          failInitialization('Configuration error: Firebase services not available. Please contact your administrator.');
          return;
        }

        if (AUTH_TOKEN_ERROR && AUTH_TOKEN_ERROR !== '') {
          failInitialization('Server error: ' + AUTH_TOKEN_ERROR);
          return;
        }

        if (!AUTH_TOKEN || AUTH_TOKEN === 'null' || AUTH_TOKEN === 'undefined' || AUTH_TOKEN === '') {
          failInitialization('Authentication token missing. Please reload the page.');
          return;
        }

        console.log('[INIT] Configuration validated, proceeding with auth...');
      } catch (earlyError) {
        console.error('[INIT] Early initialization error:', earlyError);
        failInitialization('Initialization error: ' + earlyError.message);
        return;
      }

      setLoadingStatus('Authenticating...');

      // 1. WAIT FOR SIGN IN (Crucial Step)
      try {
        await withTimeout(
          firebase.auth().signInWithCustomToken(AUTH_TOKEN),
          15000,
          'Sign-in timed out. Please retry.'
        );
        console.log('[AUTH] Signed in successfully');

        // Start session timeout monitoring
        startSessionTimeoutMonitor();

      } catch (error) {
        console.error('[AUTH] Sign in failed', error);
        failInitialization('Authentication failed. Please retry.');
        return; // Stop app if auth fails
      }

      console.log('[INIT] User:', USER_EMAIL, 'Role:', USER_ROLE);

      try {
        if (IS_TEACHER) {
          setLoadingStatus('Loading teacher dashboard...');
          await withTimeout(
            initializeTeacherDashboard(),
            15000,
            'Loading teacher dashboard timed out.'
          );
        } else {
          setLoadingStatus('Loading student view...');
          await withTimeout(
            initializeStudentView(),
            15000,
            'Loading student view timed out.'
          );
        }

        DOM.loadingOverlay.classList.add('hidden');
        DOM.app.classList.remove('hidden');
        stopInitWatchdog();

      } catch (error) {
        console.error('[INIT] Failed:', error);
        failInitialization('Failed to initialize application.');
      }
    }

    // ============================================
    // TEACHER DASHBOARD
    // ============================================

    async function initializeTeacherDashboard() {
      console.log('[TEACHER] Initializing dashboard...');

      // Setup tab navigation
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });

      // Load quizzes
      await loadQuizzes();
      await loadCourses();

      // Setup listeners
      setupTeacherListeners();
    }

    function switchTab(tabId) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabId);
      });
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.toggle('active', panel.id === `${tabId}Panel`);
      });
    }

    async function loadQuizzes() {
      try {
        const snapshot = await db.collection('quizzes')
          .where('createdBy', '==', USER_EMAIL)
          .orderBy('createdAt', 'desc')
          .get();

        AppState.quizzes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderQuizList();
        updateQuizSelects();

      } catch (error) {
        console.error('[TEACHER] Failed to load quizzes:', error);
        showToast('Failed to load quizzes', 'error');
      }
    }

    function renderQuizList() {
      const container = document.getElementById('quizList');

      if (AppState.quizzes.length === 0) {
        container.innerHTML = `
          <div class="text-center text-muted" style="grid-column: 1/-1; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 15px;">üìù</div>
            <p>No quizzes yet. Create your first quiz!</p>
          </div>
        `;
        return;
      }

      // Clear container
      container.innerHTML = '';

      // Build quiz cards safely
      AppState.quizzes.forEach(quiz => {
        const card = document.createElement('div');
        card.className = 'quiz-card';

        const title = document.createElement('h3');
        title.className = 'quiz-card-title';
        title.textContent = quiz.title || 'Untitled Quiz';

        const desc = document.createElement('p');
        desc.className = 'text-muted';
        desc.style.fontSize = '13px';
        desc.textContent = quiz.description || 'No description';

        const meta = document.createElement('div');
        meta.className = 'quiz-card-meta';

        const badge = document.createElement('span');
        badge.className = `status-badge ${quiz.status?.toLowerCase() || 'draft'}`;
        badge.textContent = quiz.status || 'DRAFT';

        const actions = document.createElement('div');
        actions.className = 'flex gap-10';

        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-sm btn-outline';
        editBtn.textContent = 'Edit';
        editBtn.onclick = () => editQuiz(quiz.id);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-sm btn-danger';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteQuiz(quiz.id);

        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
        meta.appendChild(badge);
        meta.appendChild(actions);

        card.appendChild(title);
        card.appendChild(desc);
        card.appendChild(meta);
        container.appendChild(card);
      });
    }

    function updateQuizSelects() {
      const activeSelect = document.getElementById('activeQuizSelect');
      const matrixSelect = document.getElementById('matrixQuizSelect');

      // Clear existing options
      activeSelect.innerHTML = '';
      matrixSelect.innerHTML = '';

      // Add default option
      const defaultOpt1 = document.createElement('option');
      defaultOpt1.value = '';
      defaultOpt1.textContent = 'Select Quiz...';
      activeSelect.appendChild(defaultOpt1);

      const defaultOpt2 = document.createElement('option');
      defaultOpt2.value = '';
      defaultOpt2.textContent = 'Select Quiz...';
      matrixSelect.appendChild(defaultOpt2);

      // Add quiz options safely
      AppState.quizzes.forEach(q => {
        const opt1 = document.createElement('option');
        opt1.value = q.id;
        opt1.textContent = q.title || 'Untitled';
        activeSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = q.id;
        opt2.textContent = q.title || 'Untitled';
        matrixSelect.appendChild(opt2);
      });

      // Add change listeners
      document.getElementById('activeQuizSelect').onchange = (e) => {
        if (e.target.value) selectQuizForProctoring(e.target.value);
      };
      document.getElementById('matrixQuizSelect').onchange = (e) => {
        if (e.target.value) loadMatrixData(e.target.value);
      };
    }

    async function loadCourses() {
      try {
        const snapshot = await db.collection('courses')
          .orderBy('createdAt', 'desc')
          .get();

        AppState.courses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateCourseSelects();
        renderCoursesList();

      } catch (error) {
        console.error('[COURSES] Failed to load courses:', error);
        showToast('Failed to load courses', 'error');
      }
    }

    function updateCourseSelects() {
      const courseSelect = document.getElementById('courseSelect');
      const rosterSelect = document.getElementById('newQuizRosterSelect');

      if (courseSelect) {
        courseSelect.innerHTML = '';

        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = 'Select course...';
        courseSelect.appendChild(defaultOpt);

        AppState.courses.forEach(course => {
          const opt = document.createElement('option');
          opt.value = course.id;
          opt.textContent = `${course.name || 'Course'}${course.block ? ` (${course.block})` : ''}`;
          courseSelect.appendChild(opt);
        });

        courseSelect.onchange = (e) => {
          AppState.selectedCourseId = e.target.value || null;
        };
      }

      if (rosterSelect) {
        rosterSelect.innerHTML = '';

        const noRosterOpt = document.createElement('option');
        noRosterOpt.value = '';
        noRosterOpt.textContent = 'No roster';
        rosterSelect.appendChild(noRosterOpt);

        AppState.courses.forEach(course => {
          const opt = document.createElement('option');
          opt.value = course.id;
          opt.textContent = `${course.name || 'Course'}${course.block ? ` (${course.block})` : ''}`;
          rosterSelect.appendChild(opt);
        });
      }
    }

    function showCreateQuizModal() {
      document.getElementById('newQuizTitle').value = '';
      document.getElementById('newQuizDescription').value = '';
      document.getElementById('newQuizRosterSelect').value = '';
      DOM.createQuizModal.classList.remove('hidden');
    }

    function closeCreateQuizModal() {
      DOM.createQuizModal.classList.add('hidden');
    }

    async function createNewQuiz() {
      const title = document.getElementById('newQuizTitle').value.trim();
      const description = document.getElementById('newQuizDescription').value.trim();
      const rosterCourseId = document.getElementById('newQuizRosterSelect').value || null;

      // Input validation
      if (!title) {
        showToast('Please enter a quiz title', 'warning');
        return;
      }

      if (title.length > 200) {
        showToast('Quiz title must be 200 characters or less', 'warning');
        return;
      }

      if (description.length > 1000) {
        showToast('Description must be 1000 characters or less', 'warning');
        return;
      }

      try {
        const quizRef = await db.collection('quizzes').add({
          title,
          description,
          status: 'DRAFT',
          createdBy: USER_EMAIL,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          rosterCourseId,
          settings: {
            shuffleQuestions: false,
            shuffleOptions: true,
            showResults: false
          }
        });

        closeCreateQuizModal();
        showToast('Quiz created successfully!', 'success');
        await loadQuizzes();
        editQuiz(quizRef.id);

      } catch (error) {
        console.error('[TEACHER] Failed to create quiz:', error);
        showToast('Failed to create quiz', 'error');
      }
    }

    async function editQuiz(quizId) {
      AppState.currentEditingQuiz = quizId;
      const quiz = AppState.quizzes.find(q => q.id === quizId);

      document.getElementById('editingQuizTitle').textContent = quiz?.title || 'Quiz Questions';

      // Toggle Views
      document.getElementById('quizList').parentElement.classList.add('hidden'); // Hide list card
      document.getElementById('quizEditorView').classList.remove('hidden');
      document.getElementById('quizEditorView').style.display = 'flex'; // Ensure flex layout

      await loadQuestions(quizId);
    }

    async function loadQuestions(quizId) {
      try {
        const snapshot = await db.collection('quizzes').doc(quizId)
          .collection('questions').orderBy('order').get();

        const questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        AppState.currentQuestions = questions;
        renderQuestionsList(questions);

      } catch (error) {
        console.error('[TEACHER] Failed to load questions:', error);
        showToast('Failed to load questions', 'error');
      }
    }

    function renderQuestionsList(questions) {
      const container = document.getElementById('questionsSidebarList');
      container.innerHTML = '';

      if (questions.length === 0) {
        container.innerHTML = `
          <div class="text-center text-muted p-10">
            <small>No questions yet.</small>
          </div>
        `;
        selectQuestion(null);
        return;
      }

      questions.forEach((q, idx) => {
        const item = document.createElement('div');
        item.className = 'question-list-item';
        item.id = `qitem_${q.id}`;
        item.onclick = () => selectQuestion(q.id);

        const label = document.createElement('div');
        label.className = 'flex flex-col';
        label.innerHTML = `
          <span class="font-bold text-sm">Question ${idx + 1}</span>
          <span class="text-xs text-muted truncate" style="max-width: 180px;">
            ${q.text ? q.text.substring(0, 30) + (q.text.length > 30 ? '...' : '') : 'Empty question'}
          </span>
        `;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'text-danger hover:text-red-700 px-2';
        deleteBtn.innerHTML = 'üóëÔ∏è';
        deleteBtn.title = 'Delete Question';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteQuestion(q.id);
        };

        item.appendChild(label);
        item.appendChild(deleteBtn);
        container.appendChild(item);
      });

      // Select logic
      if (AppState.currentQuestionId && questions.find(q => q.id === AppState.currentQuestionId)) {
        selectQuestion(AppState.currentQuestionId);
      } else {
        selectQuestion(questions[0].id);
      }
    }

    function selectQuestion(questionId) {
      AppState.currentQuestionId = questionId;

      document.querySelectorAll('.question-list-item').forEach(el => el.classList.remove('active'));
      if (questionId) {
        const activeItem = document.getElementById(`qitem_${questionId}`);
        if (activeItem) activeItem.classList.add('active');

        document.getElementById('emptyEditorState').classList.add('hidden');
        document.getElementById('activeQuestionEditor').classList.remove('hidden');

        const question = AppState.currentQuestions.find(q => q.id === questionId);
        renderQuestionEditor(question);
      } else {
        document.getElementById('emptyEditorState').classList.remove('hidden');
        document.getElementById('activeQuestionEditor').classList.add('hidden');
      }
    }

    function renderQuestionEditor(q) {
      const container = document.getElementById('activeQuestionEditor');
      container.innerHTML = '';

      if (!q) return;

      const editor = document.createElement('div');
      editor.className = 'question-card';

      // Question Text
      const textGroup = document.createElement('div');
      textGroup.className = 'form-group';
      textGroup.innerHTML = `
        <label class="form-label">Question Text</label>
        <textarea id="qtext_${q.id}" class="form-textarea" rows="4" placeholder="Enter your question here..."></textarea>
      `;
      // We set value programmatically to avoid HTML injection issues in template literals
      const textarea = textGroup.querySelector('textarea');
      // Fix: Handle quotes in text properly or just use value property
      textarea.value = q.text || '';
      textarea.onchange = () => updateQuestion(q.id);

      editor.appendChild(textGroup);

      // Question Image
      const imageGroup = document.createElement('div');
      imageGroup.className = 'form-group mt-20';

      const uploadZone = document.createElement('div');
      uploadZone.className = 'upload-zone';
      uploadZone.onclick = () => triggerImageUpload('question', q.id);

      if (q.imageUrl) {
        uploadZone.innerHTML = `
           <img src="${sanitizeURL(q.imageUrl)}" class="image-preview" id="qimg_preview_${q.id}">
           <div class="mt-2 text-xs text-muted">Click to change image</div>
         `;
      } else {
        uploadZone.innerHTML = `
          <div class="upload-icon">üì∑</div>
          <div class="upload-text">Click to upload question image (optional)</div>
        `;
      }

      // Hidden Input
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.id = `qimg_input_${q.id}`;
      fileInput.className = 'hidden';
      fileInput.accept = 'image/*';
      fileInput.onchange = function () { uploadQuestionImage(q.id, this); };

      imageGroup.appendChild(document.createElement('label')).className = 'form-label';
      imageGroup.firstChild.textContent = 'Question Image';
      imageGroup.appendChild(uploadZone);
      imageGroup.appendChild(fileInput);

      // Progress Bar
      const progressDiv = document.createElement('div');
      progressDiv.id = `qimg_progress_${q.id}`;
      progressDiv.className = 'progress-bar hidden mt-10';
      progressDiv.innerHTML = '<div class="progress-fill" style="width: 0%"></div>';
      imageGroup.appendChild(progressDiv);

      editor.appendChild(imageGroup);

      // Options Section
      const optionsGroup = document.createElement('div');
      optionsGroup.className = 'form-group mt-30';
      optionsGroup.innerHTML = '<label class="form-label">Answer Options</label>';

      const optionsContainer = document.createElement('div');
      optionsContainer.id = `options_${q.id}`;

      (q.options || []).forEach((opt, optIdx) => {
        const optRow = document.createElement('div');
        optRow.className = 'option-editor';
        optRow.innerHTML = `
          <div class="flex-1">
             <input type="text" class="form-input" placeholder="Option text" value="${(opt.text || '').replace(/"/g, '&quot;')}">
          </div>
          <label class="correct-checkbox flex items-center gap-2 cursor-pointer" title="Mark as correct answer">
            <input type="radio" name="correct_${q.id}" ${opt.isCorrect ? 'checked' : ''}>
            <span class="text-sm font-bold ${opt.isCorrect ? 'text-success' : 'text-muted'}">Correct</span>
          </label>
          <button class="btn btn-sm btn-outline" title="Upload Option Image">
             ${opt.imageUrl ? 'üñºÔ∏è' : 'üì∑'}
          </button>
          <input type="file" id="optimg_${q.id}_${optIdx}" class="hidden" accept="image/*">
        `;

        // Bind Events
        const textInput = optRow.querySelector('input[type="text"]');
        textInput.onchange = (e) => updateOption(q.id, optIdx, 'text', e.target.value);

        const radio = optRow.querySelector('input[type="radio"]');
        radio.onchange = () => {
          updateOption(q.id, optIdx, 'isCorrect', true);
          // Visual update for radio buttons
          const allLabels = optionsContainer.querySelectorAll('.correct-checkbox span');
          allLabels.forEach(el => { el.className = 'text-sm font-bold text-muted'; }); // Reset
          radio.nextElementSibling.className = 'text-sm font-bold text-success'; // Set active
        };

        const imgBtn = optRow.querySelector('button');
        imgBtn.onclick = () => triggerOptionImageUpload(q.id, optIdx);

        const fileIn = optRow.querySelector('input[type="file"]');
        fileIn.onchange = function () { uploadOptionImage(q.id, optIdx, this); };

        optionsContainer.appendChild(optRow);
      });

      const addOptionBtn = document.createElement('button');
      addOptionBtn.className = 'btn btn-sm btn-outline mt-10 w-full';
      addOptionBtn.textContent = '+ Add Another Option';
      addOptionBtn.onclick = () => addOption(q.id);

      optionsGroup.appendChild(optionsContainer);
      optionsGroup.appendChild(addOptionBtn);
      editor.appendChild(optionsGroup);

      container.appendChild(editor);
    }

    function closeQuizEditor() {
      document.getElementById('quizEditorView').classList.add('hidden');
      document.getElementById('quizList').parentElement.classList.remove('hidden'); // Show card
      AppState.currentEditingQuiz = null;
      AppState.currentQuestionId = null;
      // Refresh list to show potential title changes
      loadQuizzes();
    }

    async function addNewQuestion() {
      if (!AppState.currentEditingQuiz) return;

      try {
        const questionsRef = db.collection('quizzes').doc(AppState.currentEditingQuiz).collection('questions');
        const snapshot = await questionsRef.get();
        const order = snapshot.size;

        await questionsRef.add({
          text: '',
          imageUrl: null,
          options: [
            { id: 'a', text: '', imageUrl: null, isCorrect: true },
            { id: 'b', text: '', imageUrl: null, isCorrect: false },
            { id: 'c', text: '', imageUrl: null, isCorrect: false },
            { id: 'd', text: '', imageUrl: null, isCorrect: false }
          ],
          order,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        await loadQuestions(AppState.currentEditingQuiz);
        showToast('Question added', 'success');

      } catch (error) {
        console.error('[TEACHER] Failed to add question:', error);
        showToast('Failed to add question', 'error');
      }
    }

    async function updateQuestion(questionId) {
      const text = document.getElementById(`qtext_${questionId}`).value;

      try {
        await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId)
          .update({ text, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      } catch (error) {
        console.error('[TEACHER] Failed to update question:', error);
      }
    }

    function buildQuestionDraft(questionId) {
      const question = AppState.currentQuestions.find(q => q.id === questionId);
      const text = document.getElementById(`qtext_${questionId}`)?.value ?? '';
      const optionRows = document.querySelectorAll(`#options_${questionId} .option-editor`);

      const options = Array.from(optionRows).map((row, idx) => {
        const input = row.querySelector('input.form-input');
        const radio = row.querySelector('input[type="radio"]');
        const baseOption = question?.options?.[idx] || {};

        return {
          id: baseOption.id || `opt_${idx}`,
          text: input ? input.value : '',
          imageUrl: baseOption.imageUrl || null,
          isCorrect: Boolean(radio?.checked)
        };
      });

      return { text, options };
    }

    async function saveQuestion(questionId, { showSuccess = true, showErrors = true } = {}) {
      if (!AppState.currentEditingQuiz) return;

      const draft = buildQuestionDraft(questionId);
      if (!draft) return;

      // Input validation
      if (draft.text.length > 5000) {
        if (showErrors) {
          showToast('Question text must be 5000 characters or less', 'warning');
        }
        return;
      }

      // Validate options
      for (let opt of draft.options) {
        if (opt.text && opt.text.length > 1000) {
          if (showErrors) {
            showToast('Option text must be 1000 characters or less', 'warning');
          }
          return;
        }
      }

      try {
        await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId)
          .update({
            text: draft.text,
            options: draft.options,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

        if (showSuccess) {
          showToast('Saved', 'success');
        }
      } catch (error) {
        logger.error('[TEACHER] Failed to save question:', error);
        if (showErrors) {
          showToast('Failed to save question', 'error');
        }
        throw error;
      }
    }

    async function saveAllQuestions() {
      if (!AppState.currentQuestions.length) {
        showToast('No questions to save', 'warning');
        return;
      }

      try {
        await Promise.all(
          AppState.currentQuestions.map(question => saveQuestion(question.id, {
            showSuccess: false,
            showErrors: false
          }))
        );
        showToast('All questions saved', 'success');
      } catch (error) {
        console.error('[TEACHER] Failed to save all questions:', error);
        showToast('Failed to save all questions', 'error');
      }
    }

    async function deleteQuestion(questionId) {
      if (!confirm('Delete this question?')) return;

      try {
        await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId).delete();

        await loadQuestions(AppState.currentEditingQuiz);
        showToast('Question deleted', 'success');

      } catch (error) {
        console.error('[TEACHER] Failed to delete question:', error);
        showToast('Failed to delete question', 'error');
      }
    }

    function triggerImageUpload(type, id) {
      document.getElementById(`qimg_input_${id}`).click();
    }

    function triggerOptionImageUpload(questionId, optIdx) {
      document.getElementById(`optimg_${questionId}_${optIdx}`).click();
    }

    async function uploadQuestionImage(questionId, input) {
      if (!input.files[0]) return;

      const file = input.files[0];
      const progressBar = document.getElementById(`qimg_progress_${questionId}`);
      const progressFill = progressBar.querySelector('.progress-fill');

      progressBar.classList.remove('hidden');

      try {
        const storageRef = storage.ref(`quizzes/${AppState.currentEditingQuiz}/questions/${questionId}_${Date.now()}`);
        const metadata = { contentType: file.type };
        const uploadTask = storageRef.put(file, metadata);

        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progressFill.style.width = progress + '%';
          },
          (error) => {
            console.error('[UPLOAD] Error:', error);
            showToast('Upload failed', 'error');
            progressBar.classList.add('hidden');
          },
          async () => {
            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();

            await db.collection('quizzes').doc(AppState.currentEditingQuiz)
              .collection('questions').doc(questionId)
              .update({ imageUrl: downloadURL });

            progressBar.classList.add('hidden');
            showToast('Image uploaded', 'success');
            await loadQuestions(AppState.currentEditingQuiz);
          }
        );

      } catch (error) {
        console.error('[UPLOAD] Error:', error);
        showToast('Upload failed', 'error');
        progressBar.classList.add('hidden');
      }
    }

    async function uploadOptionImage(questionId, optIdx, input) {
      if (!input.files[0]) return;

      const file = input.files[0];

      try {
        showToast('Uploading...', 'info');

        const storageRef = storage.ref(`quizzes/${AppState.currentEditingQuiz}/options/${questionId}_opt${optIdx}_${Date.now()}`);
        const metadata = { contentType: file.type };
        const snapshot = await storageRef.put(file, metadata);
        const downloadURL = await snapshot.ref.getDownloadURL();

        // Get current question
        const doc = await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId).get();

        const options = doc.data().options || [];
        options[optIdx].imageUrl = downloadURL;

        await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId)
          .update({ options });

        showToast('Option image uploaded', 'success');
        await loadQuestions(AppState.currentEditingQuiz);

      } catch (error) {
        console.error('[UPLOAD] Option image error:', error);
        showToast('Upload failed', 'error');
      }
    }

    async function updateOption(questionId, optIdx, field, value) {
      try {
        const doc = await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId).get();

        const options = doc.data().options || [];

        if (field === 'isCorrect') {
          // Unset all others
          options.forEach((opt, i) => opt.isCorrect = (i === optIdx));
        } else {
          options[optIdx][field] = value;
        }

        await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId)
          .update({ options });

      } catch (error) {
        console.error('[TEACHER] Failed to update option:', error);
      }
    }

    async function addOption(questionId) {
      try {
        const doc = await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId).get();

        const options = doc.data().options || [];
        const letters = 'abcdefghij';
        options.push({
          id: letters[options.length] || `opt_${options.length}`,
          text: '',
          imageUrl: null,
          isCorrect: false
        });

        await db.collection('quizzes').doc(AppState.currentEditingQuiz)
          .collection('questions').doc(questionId)
          .update({ options });

        await loadQuestions(AppState.currentEditingQuiz);

      } catch (error) {
        console.error('[TEACHER] Failed to add option:', error);
      }
    }



    async function deleteQuiz(quizId) {
      if (!confirm('Are you sure you want to delete this quiz and all its questions?')) return;

      try {
        // Delete questions subcollection first
        const questionsSnapshot = await db.collection('quizzes').doc(quizId).collection('questions').get();
        const batch = db.batch();
        questionsSnapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();

        // Delete quiz
        await db.collection('quizzes').doc(quizId).delete();

        showToast('Quiz deleted', 'success');
        await loadQuizzes();

      } catch (error) {
        console.error('[TEACHER] Failed to delete quiz:', error);
        showToast('Failed to delete quiz', 'error');
      }
    }

    // ============================================
    // PROCTORING
    // ============================================

    function setupTeacherListeners() {
      // Listen to authorized teachers
      const teacherUnsub = db.collection('authorized_teachers')
        .onSnapshot(snapshot => {
          AppState.teachers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          renderTeachersList();
        });

      AppState.unsubscribers.push(teacherUnsub);
    }

    function selectQuizForProctoring(quizId) {
      AppState.currentQuizId = quizId;

      // Clear existing listener
      if (AppState.sessionListener) {
        AppState.sessionListener();
      }

      updateInviteButton(quizId);

      // Update UI
      const quiz = AppState.quizzes.find(q => q.id === quizId);
      const banner = document.getElementById('quizStatusBanner');
      banner.classList.remove('hidden');

      if (quiz?.status === 'OPEN') {
        banner.style.background = 'rgba(72, 187, 120, 0.2)';
        banner.style.color = '#48bb78';
        banner.innerHTML = 'üü¢ Quiz is OPEN - Students can submit answers';
      } else {
        banner.style.background = 'rgba(245, 101, 101, 0.2)';
        banner.style.color = '#f56565';
        banner.innerHTML = 'üî¥ Quiz is CLOSED - Open it to allow submissions';
      }

      // Listen to sessions
      AppState.sessionListener = db.collection('sessions').doc(quizId)
        .collection('students')
        .onSnapshot(snapshot => {
          updateRoster(snapshot.docs);
        });

      AppState.unsubscribers.push(AppState.sessionListener);
    }

    function updateRoster(docs) {
      document.getElementById('studentCount').textContent = `${docs.length} Student${docs.length !== 1 ? 's' : ''}`;

      if (docs.length === 0) {
        document.getElementById('rosterBody').innerHTML = `
          <tr><td colspan="6" class="text-center text-muted">No students connected</td></tr>
        `;
        return;
      }

      document.getElementById('rosterBody').innerHTML = docs.map(doc => {
        const data = doc.data();
        const email = data.email || doc.id;
        const status = data.status || 'active';
        const violations = data.violations?.length || 0;
        const progress = data.progress || 0;
        const lastHeartbeat = data.lastHeartbeat;
        const isRecent = lastHeartbeat && (Date.now() - lastHeartbeat.toDate().getTime()) < 30000;

        return `
          <tr>
            <td>${email}</td>
            <td>
              <span class="status-badge ${isRecent ? 'active' : 'blocked'}">
                ${isRecent ? 'Connected' : 'Disconnected'}
              </span>
            </td>
            <td>
              <span class="status-badge ${status}">${status}</span>
            </td>
            <td>
              <div class="progress-bar" style="width: 100px; height: 6px;">
                <div class="progress-fill" style="width: ${progress}%"></div>
              </div>
              <span style="font-size: 11px; color: var(--gray);">${progress}%</span>
            </td>
            <td class="${violations > 0 ? 'text-danger' : ''}">${violations}</td>
            <td>
              ${status === 'blocked' ? `
                <button class="btn btn-sm btn-warning" onclick="unlockStudent('${doc.id}')">Unlock</button>
              ` : '-'}
            </td>
          </tr>
        `;
      }).join('');
    }

    async function unlockStudent(studentDocId) {
      if (!AppState.currentQuizId) return;

      try {
        await db.collection('sessions').doc(AppState.currentQuizId)
          .collection('students').doc(studentDocId)
          .update({
            status: 'active',
            unlockedAt: firebase.firestore.FieldValue.serverTimestamp(),
            unlockedBy: USER_EMAIL
          });

        showToast('Student unlocked', 'success');

      } catch (error) {
        console.error('[TEACHER] Failed to unlock student:', error);
        showToast('Failed to unlock student', 'error');
      }
    }

    async function toggleQuizStatus(status) {
      const quizId = document.getElementById('activeQuizSelect').value;
      if (!quizId) {
        showToast('Please select a quiz first', 'warning');
        return;
      }

      try {
        await db.collection('quizzes').doc(quizId).update({
          status,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Also update global state
        await db.collection('sys_admin').doc('global_state').set({
          activeQuizId: status === 'OPEN' ? quizId : null,
          status,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: USER_EMAIL
        }, { merge: true });

        if (status === 'OPEN') {
          await preseedRosterSessions(quizId);
        }

        showToast(`Quiz ${status === 'OPEN' ? 'opened' : 'closed'}`, 'success');
        await loadQuizzes();
        selectQuizForProctoring(quizId);

      } catch (error) {
        console.error('[TEACHER] Failed to update quiz status:', error);
        showToast('Failed to update quiz status', 'error');
      }
    }

    function getQuizRosterCourseId(quizId) {
      const quiz = AppState.quizzes.find(q => q.id === quizId);
      return quiz?.rosterCourseId || null;
    }

    function updateInviteButton(quizId) {
      const rosterCourseId = getQuizRosterCourseId(quizId);
      const btn = document.getElementById('sendInvitesBtn');
      if (!btn) return;

      if (!rosterCourseId) {
        btn.disabled = true;
        btn.title = "This quiz does not have a roster attached. Edit the quiz settings to add a roster.";
      } else {
        btn.disabled = false;
        btn.title = "Send email invitations to all students in the roster.";
      }
    }

    async function preseedRosterSessions(quizId) {
      const rosterCourseId = getQuizRosterCourseId(quizId);
      if (!rosterCourseId) return;

      try {
        const rosterSnapshot = await db.collection('courses').doc(rosterCourseId)
          .collection('roster').get();

        if (rosterSnapshot.empty) {
          return;
        }

        const sessionSnapshot = await db.collection('sessions').doc(quizId)
          .collection('students').get();
        const existingIds = new Set(sessionSnapshot.docs.map(doc => doc.id));

        const batch = db.batch();
        rosterSnapshot.docs.forEach(doc => {
          if (existingIds.has(doc.id)) return;
          const data = doc.data();
          const sessionRef = db.collection('sessions').doc(quizId)
            .collection('students').doc(doc.id);
          batch.set(sessionRef, {
            email: data.email || doc.id,
            name: data.name || '',
            block: data.block || '',
            status: 'invited',
            connectedAt: null,
            lastHeartbeat: null,
            violations: [],
            progress: 0
          }, { merge: true });
        });

        await batch.commit();
      } catch (error) {
        console.error('[TEACHER] Failed to preseed roster sessions:', error);
        showToast('Failed to preseed roster sessions', 'error');
      }
    }

    // Rate limiting for email invitations
    const inviteRateLimiter = {
      lastSent: {},
      cooldownMs: 60000, // 1 minute cooldown between sends

      canSend: function (quizId) {
        const now = Date.now();
        const lastSentTime = this.lastSent[quizId] || 0;
        return (now - lastSentTime) > this.cooldownMs;
      },

      recordSent: function (quizId) {
        this.lastSent[quizId] = Date.now();
      },

      getTimeRemaining: function (quizId) {
        const now = Date.now();
        const lastSentTime = this.lastSent[quizId] || 0;
        const elapsed = now - lastSentTime;
        const remaining = this.cooldownMs - elapsed;
        return Math.ceil(remaining / 1000); // seconds
      }
    };

    function sendInvitesForActiveQuiz() {
      const quizId = document.getElementById('activeQuizSelect').value;
      if (!quizId) {
        showToast('Please select a quiz first', 'warning');
        return;
      }

      // Rate limiting check
      if (!inviteRateLimiter.canSend(quizId)) {
        const secondsRemaining = inviteRateLimiter.getTimeRemaining(quizId);
        showToast(`Please wait ${secondsRemaining} seconds before sending invites again`, 'warning');
        return;
      }

      const rosterCourseId = getQuizRosterCourseId(quizId);
      if (!rosterCourseId) {
        showToast('No roster attached to this quiz', 'warning');
        return;
      }

      // Confirmation dialog to prevent accidental sends
      if (!confirm(`Send quiz invitations to all students in the roster?\n\nThis will send email notifications to all students.`)) {
        return;
      }

      showToast('Sending invites...', 'info');
      inviteRateLimiter.recordSent(quizId);

      google.script.run
        .withSuccessHandler((result) => {
          if (result?.success) {
            showToast(`Invites sent: ${result.sent}`, 'success');
          } else {
            showToast('Failed to send invites', 'error');
          }
        })
        .withFailureHandler((error) => {
          console.error('[INVITES] Failed to send invites:', error);
          showToast('Failed to send invites', 'error');
        })
        .sendQuizInvites(quizId, rosterCourseId);
    }

    // ============================================
    // THE MATRIX (Analytics)
    // ============================================

    async function loadMatrixData(quizId) {
      try {
        const snapshot = await db.collection('responses').doc(quizId)
          .collection('students').get();

        const students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderMatrix(students);

      } catch (error) {
        console.error('[TEACHER] Failed to load matrix data:', error);
        showToast('Failed to load analytics', 'error');
      }
    }

    function renderMatrix(students) {
      // Clear quadrants
      document.getElementById('quadrantTL').innerHTML = '';
      document.getElementById('quadrantTR').innerHTML = '';
      document.getElementById('quadrantBL').innerHTML = '';
      document.getElementById('quadrantBR').innerHTML = '';

      let misconceptions = 0, mastery = 0, learning = 0, luckyGuess = 0;

      students.forEach(student => {
        const answers = student.answers || {};

        Object.values(answers).forEach(answer => {
          const isCorrect = answer.isCorrect;
          const confidence = answer.confidence || 2;
          const isHighConfidence = confidence >= 3;

          const dot = document.createElement('div');
          dot.className = 'student-dot';
          dot.title = `${student.email}\nAnswer: ${answer.answer}\nConfidence: ${confidence}\n${isCorrect ? 'Correct' : 'Incorrect'}`;

          if (!isCorrect && isHighConfidence) {
            // MISCONCEPTION - High confidence + Wrong
            dot.classList.add('misconception');
            document.getElementById('quadrantTL').appendChild(dot);
            misconceptions++;
          } else if (isCorrect && isHighConfidence) {
            // MASTERY - High confidence + Correct
            dot.classList.add('correct-confident');
            document.getElementById('quadrantTR').appendChild(dot);
            mastery++;
          } else if (!isCorrect && !isHighConfidence) {
            // LEARNING - Low confidence + Wrong
            dot.classList.add('incorrect-unsure');
            document.getElementById('quadrantBL').appendChild(dot);
            learning++;
          } else {
            // LUCKY GUESS - Low confidence + Correct
            dot.classList.add('correct-unsure');
            document.getElementById('quadrantBR').appendChild(dot);
            luckyGuess++;
          }
        });
      });

      const total = misconceptions + mastery + learning + luckyGuess;
      document.getElementById('matrixStats').innerHTML = `
        <strong>Total Responses:</strong> ${total}<br>
        <span class="text-danger">Misconceptions: ${misconceptions}</span> |
        <span class="text-success">Mastery: ${mastery}</span><br>
        <span class="text-warning">Learning: ${learning}</span> |
        <span style="color: var(--info)">Lucky Guess: ${luckyGuess}</span>
      `;
    }

    // ============================================
    // ADMIN PANEL
    // ============================================

    function renderTeachersList() {
      const tbody = document.getElementById('teachersList');

      if (AppState.teachers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No teachers found</td></tr>`;
        return;
      }

      tbody.innerHTML = AppState.teachers.map(teacher => `
        <tr>
          <td>${teacher.email || teacher.id}</td>
          <td>${teacher.displayName || '-'}</td>
          <td><span class="status-badge active">${teacher.role || 'teacher'}</span></td>
          <td class="text-muted">${formatTime(teacher.addedAt)}</td>
          <td>
            ${teacher.email !== USER_EMAIL ? `
              <button class="btn btn-sm btn-danger" onclick="removeTeacher('${teacher.id}')">Remove</button>
            ` : '<span class="text-muted">You</span>'}
          </td>
        </tr>
      `).join('');
    }

    async function addTeacher() {
      const email = document.getElementById('newTeacherEmail').value.trim().toLowerCase();

      // Comprehensive email validation
      if (!isValidEmail(email)) {
        showToast('Please enter a valid email address', 'warning');
        return;
      }

      // CSRF protection: Confirmation step
      if (!confirm(`Add ${email} as an authorized teacher?\n\nThis will grant them full access to create quizzes, view student data, and manage courses.`)) {
        return;
      }

      try {
        // Check if teacher already exists
        const existingDoc = await db.collection('authorized_teachers').doc(email).get();
        if (existingDoc.exists) {
          showToast('Teacher already authorized', 'warning');
          return;
        }

        await db.collection('authorized_teachers').doc(email).set({
          email,
          displayName: email.split('@')[0],
          role: 'teacher',
          addedBy: USER_EMAIL,
          addedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        document.getElementById('newTeacherEmail').value = '';
        showToast('Teacher added successfully', 'success');

        // Log audit event
        try {
          await db.collection('audit_log').add({
            action: 'teacher_added',
            email: USER_EMAIL,
            targetEmail: email,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            details: { addedBy: USER_EMAIL }
          });
        } catch (auditError) {
          console.error('[AUDIT] Failed to log teacher addition:', auditError);
        }

      } catch (error) {
        console.error('[ADMIN] Failed to add teacher:', error);
        showToast('Failed to add teacher', 'error');
      }
    }

    async function createCourse() {
      const name = document.getElementById('newCourseName').value.trim();
      const block = document.getElementById('newCourseBlock').value.trim();

      // Input validation
      if (!name) {
        showToast('Please enter a course name', 'warning');
        return;
      }

      if (name.length > 200) {
        showToast('Course name must be 200 characters or less', 'warning');
        return;
      }

      if (block.length > 50) {
        showToast('Block/period must be 50 characters or less', 'warning');
        return;
      }

      try {
        await db.collection('courses').add({
          name,
          block,
          createdBy: USER_EMAIL,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          rosterCount: 0
        });

        document.getElementById('newCourseName').value = '';
        document.getElementById('newCourseBlock').value = '';
        showToast('Course created', 'success');
        await loadCourses();
      } catch (error) {
        console.error('[COURSES] Failed to create course:', error);
        showToast('Failed to create course', 'error');
      }
    }

    function renderCoursesList() {
      const tbody = document.getElementById('coursesListBody');
      const select = document.getElementById('courseSelect');

      // Update Select
      select.innerHTML = '<option value="">Select course...</option>' +
        AppState.courses.map(c => `<option value="${c.id}">${c.name} (${c.block})</option>`).join('');

      // Update Table
      if (AppState.courses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No courses found</td></tr>';
        return;
      }

      tbody.innerHTML = AppState.courses.map(course => `
        <tr>
          <td>
            <input type="text" class="form-input form-input-sm" 
              value="${course.name}" 
              onchange="updateCourse('${course.id}', 'name', this.value)">
          </td>
          <td>
            <input type="text" class="form-input form-input-sm" 
              value="${course.block}" 
              style="width: 80px;"
              onchange="updateCourse('${course.id}', 'block', this.value)">
          </td>
          <td>${course.rosterCount || 0}</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="deleteCourse('${course.id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    async function updateCourse(courseId, field, value) {
      try {
        await db.collection('courses').doc(courseId).update({
          [field]: value,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showToast('Course updated', 'success');
      } catch (error) {
        console.error('[COURSES] Failed to update course:', error);
        showToast('Failed to update course', 'error');
      }
    }

    async function deleteCourse(courseId) {
      if (!confirm('Are you sure? This will delete the course and all student roster data.')) return;

      try {
        // Delete roster subcollection
        const rosterSnapshot = await db.collection('courses').doc(courseId).collection('roster').get();
        const batch = db.batch();
        rosterSnapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();

        await db.collection('courses').doc(courseId).delete();
        showToast('Course deleted', 'success');
        await loadCourses();
      } catch (error) {
        console.error('[COURSES] Failed to delete course:', error);
        showToast('Failed to delete course', 'error');
      }
    }

    function parseRosterCsv(text) {
      return text
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0)
        .map(line => line.split(',').map(cell => cell.trim()))
        .filter(parts => parts[0]);
    }

    async function importRoster() {
      const courseId = document.getElementById('courseSelect').value;
      if (!courseId) {
        showToast('Please select a course', 'warning');
        return;
      }

      const rawCsv = document.getElementById('rosterCsvInput').value.trim();
      if (!rawCsv) {
        showToast('Paste roster CSV first', 'warning');
        return;
      }

      const rows = parseRosterCsv(rawCsv);
      if (rows.length === 0) {
        showToast('No valid roster rows found', 'warning');
        return;
      }

      try {
        const batch = db.batch();
        let validCount = 0;

        rows.forEach(([email, name = '', block = '']) => {
          const normalizedEmail = docIdFromEmail(email);

          // Comprehensive email validation
          if (!isValidEmail(normalizedEmail)) {
            console.warn('[ROSTER] Invalid email skipped:', email);
            return;
          }

          const rosterRef = db.collection('courses').doc(courseId)
            .collection('roster').doc(normalizedEmail);

          batch.set(rosterRef, {
            email: normalizedEmail,
            name: name.trim(),
            block: block.trim() || '',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          validCount += 1;
        });

        if (validCount === 0) {
          showToast('No valid emails found', 'warning');
          return;
        }

        await batch.commit();

        const rosterSnapshot = await db.collection('courses').doc(courseId)
          .collection('roster').get();
        await db.collection('courses').doc(courseId).update({
          rosterCount: rosterSnapshot.size,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast(`Roster updated: ${validCount} students`, 'success');
        document.getElementById('rosterCsvInput').value = '';
        await loadCourses();
      } catch (error) {
        console.error('[COURSES] Failed to import roster:', error);
        showToast('Failed to import roster', 'error');
      }
    }

    async function removeTeacher(email) {
      if (email === USER_EMAIL) {
        showToast("You can't remove yourself", 'warning');
        return;
      }

      if (!confirm(`Remove ${email} from authorized teachers?`)) return;

      try {
        await db.collection('authorized_teachers').doc(email).delete();
        showToast('Teacher removed', 'success');

      } catch (error) {
        console.error('[ADMIN] Failed to remove teacher:', error);
        showToast('Failed to remove teacher', 'error');
      }
    }

    // ============================================
    // STUDENT EXAM VIEW
    // ============================================

    async function initializeStudentView() {
      console.log('[STUDENT] Initializing student view...');

      const inviteQuizId = getInviteQuizId();
      if (inviteQuizId) {
        setupInviteQuizListener(inviteQuizId);
      } else {
        // Listen to global state
        setupGlobalStateListener();
      }

      // Setup proctoring
      setupProctoring();
    }

    function getInviteQuizId() {
      const params = new URLSearchParams(window.location.search);
      const quizId = params.get('quiz');
      return quizId ? quizId.trim() : null;
    }

    function setupInviteQuizListener(quizId) {
      const unsub = db.collection('quizzes').doc(quizId)
        .onSnapshot(async (doc) => {
          if (!doc.exists) {
            showToast('Quiz not found', 'error');
            showScreen('waitingScreen');
            return;
          }

          const data = doc.data() || {};
          if (data.status === 'OPEN') {
            AppState.currentQuizId = quizId;
            await registerStudent();
            await loadExam(quizId);
          } else {
            showScreen('waitingScreen');
          }
        });

      AppState.unsubscribers.push(unsub);
    }

    function setupGlobalStateListener() {
      const unsub = db.collection('sys_admin').doc('global_state')
        .onSnapshot(async (doc) => {
          const data = doc.data() || {};
          console.log('[STUDENT] Global state update:', data);

          if (data.status === 'OPEN' && data.activeQuizId) {
            AppState.currentQuizId = data.activeQuizId;
            await registerStudent();
            await loadExam(data.activeQuizId);
          } else {
            showScreen('waitingScreen');
          }
        });

      AppState.unsubscribers.push(unsub);
    }

    async function registerStudent() {
      if (!AppState.currentQuizId) return;

      const studentDocId = docIdFromEmail(USER_EMAIL);

      try {
        const sessionRef = db.collection('sessions').doc(AppState.currentQuizId)
          .collection('students').doc(studentDocId);

        // Check existing session
        const doc = await sessionRef.get();

        if (doc.exists) {
          const data = doc.data();
          AppState.isBlocked = data.status === 'blocked';

          if (AppState.isBlocked) {
            showBlockedScreen();
            return;
          }

          if (data.status === 'invited') {
            await sessionRef.update({
              status: 'active',
              lastHeartbeat: firebase.firestore.FieldValue.serverTimestamp(),
              connectedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        } else {
          // Create new session
          await sessionRef.set({
            email: USER_EMAIL,
            status: 'active',
            connectedAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastHeartbeat: firebase.firestore.FieldValue.serverTimestamp(),
            violations: [],
            progress: 0
          });
        }

        // Listen to own status
        setupStudentStatusListener(studentDocId);

        // Start heartbeat
        startHeartbeat(studentDocId);

      } catch (error) {
        console.error('[STUDENT] Registration failed:', error);
      }
    }

    function setupStudentStatusListener(studentDocId) {
      const unsub = db.collection('sessions').doc(AppState.currentQuizId)
        .collection('students').doc(studentDocId)
        .onSnapshot((doc) => {
          if (!doc.exists) return;

          const data = doc.data();
          const wasBlocked = AppState.isBlocked;
          AppState.isBlocked = data.status === 'blocked';

          if (AppState.isBlocked && !wasBlocked) {
            showBlockedScreen();
          } else if (!AppState.isBlocked && wasBlocked) {
            hideBlockedScreen();
          }
        });

      AppState.unsubscribers.push(unsub);
    }

    function startHeartbeat(studentDocId) {
      // Clear any existing heartbeat
      if (AppState.heartbeatIntervalId) {
        clearInterval(AppState.heartbeatIntervalId);
      }

      let failureCount = 0;
      const maxFailures = 3;

      // Improved heartbeat with 5-second interval for better monitoring
      AppState.heartbeatIntervalId = setInterval(async () => {
        if (AppState.isBlocked || !AppState.currentQuizId) return;

        try {
          await db.collection('sessions').doc(AppState.currentQuizId)
            .collection('students').doc(studentDocId)
            .update({
              lastHeartbeat: firebase.firestore.FieldValue.serverTimestamp(),
              status: AppState.isBlocked ? 'blocked' : 'active'
            });

          // Reset failure count on success
          failureCount = 0;

        } catch (error) {
          failureCount++;
          console.warn(`[HEARTBEAT] Failed (${failureCount}/${maxFailures}):`, error.message);

          // If too many failures, show warning
          if (failureCount >= maxFailures) {
            showToast('Connection unstable. Your progress may not be saved.', 'warning');
          }
        }
      }, 5000); // 5 seconds for better monitoring

      // Store interval ID in unsubscribers for cleanup
      AppState.unsubscribers.push(() => {
        if (AppState.heartbeatIntervalId) {
          clearInterval(AppState.heartbeatIntervalId);
          AppState.heartbeatIntervalId = null;
        }
      });
    }

    async function loadExam(quizId) {
      try {
        // Get quiz info
        const quizDoc = await db.collection('quizzes').doc(quizId).get();
        if (!quizDoc.exists) {
          showToast('Quiz not found', 'error');
          return;
        }

        const quiz = quizDoc.data();
        document.getElementById('quizBadge').textContent = quiz.title || 'Quiz';

        // Get questions
        const questionsSnapshot = await db.collection('quizzes').doc(quizId)
          .collection('questions').orderBy('order').get();

        AppState.questions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (AppState.questions.length === 0) {
          showToast('No questions in this quiz', 'warning');
          return;
        }

        // Check for existing responses
        const studentDocId = docIdFromEmail(USER_EMAIL);
        const responseDoc = await db.collection('responses').doc(quizId)
          .collection('students').doc(studentDocId).get();

        if (responseDoc.exists) {
          const responseData = responseDoc.data();
          AppState.answers = responseData.answers || {};

          // Check if completed
          const answeredCount = Object.keys(AppState.answers).length;
          if (answeredCount >= AppState.questions.length) {
            showCompletedScreen();
            return;
          }
        }

        // Show first unanswered question
        AppState.currentQuestionIndex = Object.keys(AppState.answers).length;
        renderCurrentQuestion();
        showScreen('examScreen');

      } catch (error) {
        console.error('[STUDENT] Failed to load exam:', error);
        showToast('Failed to load exam', 'error');
      }
    }

    function renderCurrentQuestion() {
      const question = AppState.questions[AppState.currentQuestionIndex];
      if (!question) {
        showCompletedScreen();
        return;
      }

      document.getElementById('questionCounter').textContent =
        `Question ${AppState.currentQuestionIndex + 1} of ${AppState.questions.length}`;

      document.getElementById('questionText').textContent = question.text || 'No question text';

      // Question image (with URL sanitization)
      const questionImage = document.getElementById('questionImage');
      if (question.imageUrl) {
        const sanitized = sanitizeURL(question.imageUrl);
        if (sanitized) {
          questionImage.src = sanitized;
          questionImage.classList.remove('hidden');
        } else {
          questionImage.classList.add('hidden');
        }
      } else {
        questionImage.classList.add('hidden');
      }

      // Shuffle options using Fisher-Yates
      const options = question.options || [];
      const shuffledOptions = fisherYatesShuffle(options);
      const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

      const optionsList = document.getElementById('optionsList');
      optionsList.innerHTML = '';

      shuffledOptions.forEach((opt, idx) => {
        const button = document.createElement('button');
        button.className = 'option-btn';
        button.onclick = function () {
          selectAnswer(this, opt.id, opt.text || 'Option');
        };

        const letterSpan = document.createElement('span');
        letterSpan.className = 'option-letter';
        letterSpan.textContent = letters[idx];

        const contentDiv = document.createElement('div');
        contentDiv.className = 'option-content';

        const textSpan = document.createElement('span');
        textSpan.textContent = opt.text || 'Option';

        contentDiv.appendChild(textSpan);

        if (opt.imageUrl) {
          const img = document.createElement('img');
          img.className = 'option-image';
          img.src = sanitizeURL(opt.imageUrl);
          contentDiv.appendChild(img);
        }

        button.appendChild(letterSpan);
        button.appendChild(contentDiv);
        optionsList.appendChild(button);
      });

      AppState.selectedAnswer = null;
    }

    function selectAnswer(buttonEl, optionId, optionText) {
      if (AppState.isBlocked) return;

      AppState.selectedAnswer = {
        id: optionId,
        text: optionText
      };

      // Update UI
      document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
      if (buttonEl) {
        buttonEl.classList.add('selected');
      }

      // Show metacognition modal
      document.getElementById('selectedAnswerPreview').textContent = optionText;
      AppState.selectedConfidence = null;
      document.querySelectorAll('.confidence-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('submitWithConfidenceBtn').disabled = true;
      DOM.metacognitionModal.classList.remove('hidden');
    }

    function selectConfidence(level) {
      AppState.selectedConfidence = level;
      document.querySelectorAll('.confidence-btn').forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.dataset.confidence) === level);
      });
      document.getElementById('submitWithConfidenceBtn').disabled = false;
    }

    function cancelMetacognition() {
      DOM.metacognitionModal.classList.add('hidden');
      AppState.selectedAnswer = null;
      document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
    }

    async function submitWithConfidence() {
      if (!AppState.selectedAnswer || !AppState.selectedConfidence || AppState.isBlocked) return;

      DOM.metacognitionModal.classList.add('hidden');

      const question = AppState.questions[AppState.currentQuestionIndex];
      const correctOption = question.options?.find(opt => opt.isCorrect);
      const isCorrect = correctOption?.id === AppState.selectedAnswer.id;

      const answerData = {
        questionId: question.id,
        answer: AppState.selectedAnswer.text,
        answerId: AppState.selectedAnswer.id,
        confidence: AppState.selectedConfidence,
        isCorrect,
        answeredAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        const studentDocId = docIdFromEmail(USER_EMAIL);
        const responseRef = db.collection('responses').doc(AppState.currentQuizId)
          .collection('students').doc(studentDocId);

        // Update response document
        await responseRef.set({
          email: USER_EMAIL,
          quizId: AppState.currentQuizId,
          [`answers.${question.id}`]: answerData,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // Update progress
        const progress = Math.round(((AppState.currentQuestionIndex + 1) / AppState.questions.length) * 100);
        await db.collection('sessions').doc(AppState.currentQuizId)
          .collection('students').doc(studentDocId)
          .update({ progress });

        // Store locally
        AppState.answers[question.id] = answerData;

        // Move to next question
        AppState.currentQuestionIndex++;

        if (AppState.currentQuestionIndex < AppState.questions.length) {
          renderCurrentQuestion();
        } else {
          showCompletedScreen();
        }

      } catch (error) {
        console.error('[STUDENT] Failed to submit answer:', error);

        if (error.code === 'permission-denied') {
          showBlockedScreen();
        } else {
          showToast('Failed to submit. Please try again.', 'error');
        }
      }
    }

    function showCompletedScreen() {
      const totalQuestions = AppState.questions.length;
      const correctCount = Object.values(AppState.answers).filter(a => a.isCorrect).length;

      document.getElementById('completionSummary').innerHTML = `
        <div style="font-size: 18px; margin-bottom: 10px;">
          <strong>Score: ${correctCount} / ${totalQuestions}</strong>
        </div>
        <div class="text-muted">
          Accuracy: ${Math.round((correctCount / totalQuestions) * 100)}%
        </div>
      `;

      showScreen('completedScreen');
    }

    // ============================================
    // PROCTORING
    // ============================================

    function setupProctoring() {
      document.addEventListener('visibilitychange', handleVisibilityChange);

      window.addEventListener('blur', () => {
        if (!AppState.isBlocked && AppState.currentQuizId && !AppState.hasSubmitted) {
          startViolationTimer();
        }
      });

      window.addEventListener('focus', clearViolationTimer);
    }

    function handleVisibilityChange() {
      if (IS_TEACHER || AppState.isBlocked || !AppState.currentQuizId) return;

      if (document.hidden) {
        startViolationTimer();
      } else {
        clearViolationTimer();
      }
    }

    function startViolationTimer() {
      if (AppState.tabSwitchTimer) return;

      AppState.tabSwitchTimer = setTimeout(async () => {
        await recordViolation();
      }, 1500);
    }

    function clearViolationTimer() {
      if (AppState.tabSwitchTimer) {
        clearTimeout(AppState.tabSwitchTimer);
        AppState.tabSwitchTimer = null;
      }
    }

    async function recordViolation() {
      if (!AppState.currentQuizId) return;

      const studentDocId = docIdFromEmail(USER_EMAIL);

      try {
        await db.collection('sessions').doc(AppState.currentQuizId)
          .collection('students').doc(studentDocId)
          .update({
            status: 'blocked',
            violations: firebase.firestore.FieldValue.arrayUnion({
              type: 'tab_switch',
              timestamp: new Date().toISOString()
            }),
            blockedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

        AppState.isBlocked = true;
        showBlockedScreen();

      } catch (error) {
        console.error('[PROCTOR] Failed to record violation:', error);
      }
    }

    function showBlockedScreen() {
      DOM.blockedScreen.classList.remove('hidden');
      DOM.app.classList.add('hidden');
      clearViolationTimer();
    }

    function hideBlockedScreen() {
      DOM.blockedScreen.classList.add('hidden');
      DOM.app.classList.remove('hidden');
    }

    // ============================================
    // CLEANUP
    // ============================================

    function cleanup() {
      clearViolationTimer();
      AppState.unsubscribers.forEach(unsub => {
        if (typeof unsub === 'function') unsub();
      });
    }

    window.addEventListener('beforeunload', cleanup);

    // ============================================
    // START APPLICATION
    // ============================================
    console.log('[SCRIPT] Setting up initialization triggers...');

    // Handle DOMContentLoaded or immediate execution if already loaded
    if (document.readyState === 'loading') {
      console.log('[SCRIPT] DOM still loading, adding DOMContentLoaded listener');
      document.addEventListener('DOMContentLoaded', () => {
        console.log('[SCRIPT] DOMContentLoaded fired, calling initializeApp');
        initializeApp();
      });
    } else {
      // DOM already loaded (interactive or complete)
      console.log('[SCRIPT] DOM already loaded (readyState:', document.readyState, '), calling initializeApp directly');
      // Use setTimeout to ensure all scripts have finished executing
      setTimeout(() => {
        console.log('[SCRIPT] Executing initializeApp via setTimeout');
        initializeApp();
      }, 0);
    }

    window.addEventListener('error', (event) => {
      console.error('[ERROR] Unhandled error:', event.error || event.message);
      // Only call failInitialization if DOM elements are available
      if (typeof failInitialization === 'function') {
        failInitialization('An unexpected error occurred: ' + (event.message || 'Unknown error'));
      }
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('[ERROR] Unhandled promise rejection:', event.reason);
      if (typeof failInitialization === 'function') {
        failInitialization('An unexpected error occurred: ' + (event.reason?.message || event.reason || 'Unknown error'));
      }
    });

    console.log('[SCRIPT] Main script setup complete');
  </script>
</body>

</html>