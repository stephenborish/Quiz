<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Secure Assessment Platform">
  <meta name="theme-color" content="#1a1a2e">
  <title>Secure Assessment Platform</title>

  <!-- ============================================
       EMBEDDED CSS STYLES
       ============================================ -->
  <style>
    /* ==========================================
       CSS RESET & VARIABLES
       ========================================== */
    :root {
      --primary: #667eea;
      --primary-dark: #5a67d8;
      --secondary: #764ba2;
      --success: #48bb78;
      --danger: #f56565;
      --warning: #ed8936;
      --info: #4299e1;
      --dark: #1a1a2e;
      --darker: #16213e;
      --light: #f7fafc;
      --gray: #a0aec0;
      --gray-dark: #4a5568;
      --border-radius: 12px;
      --shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.2);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
      color: var(--light);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ==========================================
       LAYOUT CONTAINERS
       ========================================== */
    .app-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .header-title {
      font-size: 20px;
      font-weight: 600;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-user {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: var(--gray);
    }

    .header-badge {
      background: var(--primary);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 25px;
    }

    /* ==========================================
       SCREEN CONTAINERS (Show/Hide Logic)
       ========================================== */
    .screen {
      display: none;
      height: 100%;
    }

    .screen.active {
      display: flex;
      flex-direction: column;
    }

    /* ==========================================
       WAITING ROOM STYLES
       ========================================== */
    .waiting-room {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 40px;
    }

    .waiting-icon {
      font-size: 80px;
      margin-bottom: 30px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    .waiting-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--light);
    }

    .waiting-subtitle {
      font-size: 18px;
      color: var(--gray);
      max-width: 500px;
    }

    .waiting-status {
      margin-top: 30px;
      padding: 15px 30px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 30px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--warning);
      animation: blink 1.5s ease-in-out infinite;
    }

    .status-dot.open {
      background: var(--success);
      animation: none;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* ==========================================
       BLOCKED SCREEN STYLES
       ========================================== */
    .blocked-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      background: linear-gradient(135deg, #c0392b 0%, #8e1f0f 100%);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9999;
      padding: 40px;
    }

    .blocked-icon {
      font-size: 100px;
      margin-bottom: 30px;
    }

    .blocked-title {
      font-size: 48px;
      font-weight: 800;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 3px;
    }

    .blocked-message {
      font-size: 20px;
      opacity: 0.9;
      max-width: 500px;
    }

    /* ==========================================
       EXAM QUESTION STYLES
       ========================================== */
    .exam-container {
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
    }

    .question-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 35px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: var(--shadow);
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .question-number {
      font-size: 14px;
      color: var(--gray);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .exam-version-badge {
      background: var(--primary);
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .question-text {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 30px;
      line-height: 1.4;
    }

    .options-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .option-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--border-radius);
      padding: 18px 25px;
      color: var(--light);
      font-size: 16px;
      text-align: left;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .option-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--primary);
      transform: translateX(5px);
    }

    .option-btn.selected {
      background: rgba(102, 126, 234, 0.2);
      border-color: var(--primary);
    }

    .option-letter {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }

    .option-btn.selected .option-letter {
      background: var(--primary);
    }

    .submit-section {
      margin-top: 30px;
      display: flex;
      justify-content: center;
    }

    .submit-btn {
      background: linear-gradient(135deg, var(--success) 0%, #38a169 100%);
      color: white;
      border: none;
      padding: 15px 50px;
      border-radius: 30px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
    }

    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(72, 187, 120, 0.5);
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .submitted-message {
      text-align: center;
      padding: 40px;
    }

    .submitted-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .submitted-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 10px;
    }

    .submitted-answer {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px 25px;
      border-radius: var(--border-radius);
      margin-top: 20px;
      font-size: 18px;
    }

    /* ==========================================
       TEACHER DASHBOARD STYLES
       ========================================== */
    .dashboard-container {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .control-panel {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .control-btn {
      flex: 1;
      min-width: 200px;
      padding: 25px 30px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .control-btn.open-exam {
      background: linear-gradient(135deg, var(--success) 0%, #38a169 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(72, 187, 120, 0.4);
    }

    .control-btn.close-exam {
      background: linear-gradient(135deg, var(--danger) 0%, #c53030 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(245, 101, 101, 0.4);
    }

    .control-btn:hover {
      transform: translateY(-3px);
    }

    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .control-btn .icon {
      font-size: 24px;
    }

    .exam-status-banner {
      padding: 15px 25px;
      border-radius: var(--border-radius);
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-weight: 600;
      font-size: 16px;
    }

    .exam-status-banner.open {
      background: rgba(72, 187, 120, 0.2);
      border: 1px solid var(--success);
      color: var(--success);
    }

    .exam-status-banner.closed {
      background: rgba(245, 101, 101, 0.2);
      border: 1px solid var(--danger);
      color: var(--danger);
    }

    .roster-section {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .roster-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .roster-title {
      font-size: 20px;
      font-weight: 600;
    }

    .roster-count {
      background: var(--primary);
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .roster-table-container {
      flex: 1;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.05);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .roster-table {
      width: 100%;
      border-collapse: collapse;
    }

    .roster-table th {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px 20px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .roster-table td {
      padding: 15px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 14px;
    }

    .roster-table tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-badge.active {
      background: rgba(72, 187, 120, 0.2);
      color: var(--success);
    }

    .status-badge.blocked {
      background: rgba(245, 101, 101, 0.2);
      color: var(--danger);
    }

    .version-badge {
      background: rgba(102, 126, 234, 0.2);
      color: var(--primary);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .grade-display {
      font-weight: 600;
      font-size: 14px;
    }

    .grade-display.correct {
      color: var(--success);
    }

    .grade-display.incorrect {
      color: var(--danger);
    }

    .grade-display.pending {
      color: var(--gray);
      font-style: italic;
    }

    .unlock-btn {
      background: var(--warning);
      color: white;
      border: none;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      text-transform: uppercase;
    }

    .unlock-btn:hover {
      background: #dd7b1a;
      transform: scale(1.05);
    }

    /* ==========================================
       LOADING SPINNER
       ========================================== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 20px;
      font-size: 16px;
      color: var(--gray);
    }

    /* ==========================================
       RESPONSIVE DESIGN
       ========================================== */
    @media (max-width: 768px) {
      .header {
        padding: 12px 15px;
      }

      .header-title {
        font-size: 16px;
      }

      .main-content {
        padding: 15px;
      }

      .question-card {
        padding: 20px;
      }

      .question-text {
        font-size: 20px;
      }

      .control-btn {
        padding: 18px 20px;
        font-size: 14px;
      }

      .roster-table th,
      .roster-table td {
        padding: 10px 12px;
        font-size: 12px;
      }
    }

    /* ==========================================
       UTILITY CLASSES
       ========================================== */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .mt-20 {
      margin-top: 20px;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <!-- ============================================
       LOADING OVERLAY
       ============================================ -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Initializing Secure Assessment...</div>
  </div>

  <!-- ============================================
       BLOCKED SCREEN (Hidden by default)
       ============================================ -->
  <div id="blockedScreen" class="blocked-screen hidden">
    <div class="blocked-icon">üö´</div>
    <h1 class="blocked-title">Session Locked</h1>
    <p class="blocked-message">
      A tab switch was detected. Your exam has been paused.<br><br>
      Please see your teacher to continue.
    </p>
  </div>

  <!-- ============================================
       MAIN APPLICATION
       ============================================ -->
  <div id="app" class="app-container hidden">
    <!-- Header -->
    <header class="header">
      <h1 class="header-title">Secure Assessment Platform</h1>
      <div class="header-user">
        <span id="userEmailDisplay"></span>
        <span id="userRoleBadge" class="header-badge"></span>
      </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
      <!-- ==========================================
           TEACHER DASHBOARD SCREEN
           ========================================== -->
      <div id="teacherDashboard" class="screen">
        <div class="dashboard-container">
          <!-- Control Panel -->
          <div class="control-panel">
            <button id="openExamBtn" class="control-btn open-exam" onclick="toggleExamState(true)">
              <span class="icon">‚ñ∂Ô∏è</span>
              <span>Open Exam</span>
            </button>
            <button id="closeExamBtn" class="control-btn close-exam" onclick="toggleExamState(false)">
              <span class="icon">‚èπÔ∏è</span>
              <span>Close Exam</span>
            </button>
          </div>

          <!-- Exam Status Banner -->
          <div id="examStatusBanner" class="exam-status-banner closed">
            <span id="examStatusIcon">üî¥</span>
            <span id="examStatusText">Exam is CLOSED</span>
          </div>

          <!-- Live Roster -->
          <div class="roster-section">
            <div class="roster-header">
              <h2 class="roster-title">Live Student Roster</h2>
              <span id="studentCount" class="roster-count">0 Students</span>
            </div>
            <div class="roster-table-container">
              <table class="roster-table">
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Exam Version</th>
                    <th>Status</th>
                    <th>Response</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="rosterBody">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ==========================================
           STUDENT WAITING ROOM SCREEN
           ========================================== -->
      <div id="waitingRoom" class="screen">
        <div class="waiting-room">
          <div class="waiting-icon">‚è≥</div>
          <h1 class="waiting-title">Waiting Room</h1>
          <p class="waiting-subtitle">
            Your teacher is preparing the exam. Please wait here and do not refresh or switch tabs.
          </p>
          <div class="waiting-status">
            <div class="status-dot"></div>
            <span>Waiting for exam to open...</span>
          </div>
        </div>
      </div>

      <!-- ==========================================
           STUDENT EXAM SCREEN
           ========================================== -->
      <div id="examScreen" class="screen">
        <div class="exam-container">
          <div class="question-card">
            <div class="question-header">
              <span class="question-number">Question 1</span>
              <span id="examVersionBadge" class="exam-version-badge">Version 1</span>
            </div>
            <h2 id="questionText" class="question-text"></h2>
            <div id="optionsContainer" class="options-container">
              <!-- Populated by JavaScript -->
            </div>
            <div class="submit-section">
              <button id="submitBtn" class="submit-btn" onclick="submitAnswer()" disabled>
                Submit Answer
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ==========================================
           STUDENT SUBMITTED SCREEN
           ========================================== -->
      <div id="submittedScreen" class="screen">
        <div class="waiting-room">
          <div class="submitted-icon">‚úÖ</div>
          <h1 class="submitted-title">Answer Submitted!</h1>
          <p class="waiting-subtitle">
            Your response has been recorded. Please wait quietly for further instructions.
          </p>
          <div id="submittedAnswerBox" class="submitted-answer">
            Your answer: <strong id="submittedAnswerText"></strong>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ============================================
       FIREBASE SDK (Compat 9.22.0)
       ============================================ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- ============================================
       MAIN APPLICATION JAVASCRIPT
       ============================================ -->
  <script>
    // ============================================
    // SERVER-INJECTED VARIABLES
    // ============================================
    // These values are injected by Code.gs and are TRUSTED
    // They cannot be modified by the client
    const USER_EMAIL = '<?= userEmail ?>';
    const IS_TEACHER = <?= isTeacher ?>;
    const INITIAL_MODE = '<?= initialMode ?>';

    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    // IMPORTANT: Replace these placeholders with your Firebase project config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY_HERE",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ============================================
    // EXAM CONTENT DEFINITIONS
    // ============================================
    // 5 Versions of questions for randomization
    // Each student is assigned ONE version that persists
    const EXAMS = {
      1: {
        id: 'q1',
        question: 'What is the powerhouse of the cell?',
        options: ['Nucleus', 'Mitochondria', 'Ribosome', 'Golgi Apparatus'],
        correct_answer: 'Mitochondria'
      },
      2: {
        id: 'q2',
        question: 'Which planet is known as the Red Planet?',
        options: ['Venus', 'Jupiter', 'Mars', 'Saturn'],
        correct_answer: 'Mars'
      },
      3: {
        id: 'q3',
        question: 'What is the chemical symbol for Gold?',
        options: ['Go', 'Gd', 'Au', 'Ag'],
        correct_answer: 'Au'
      },
      4: {
        id: 'q4',
        question: 'Who wrote "Romeo and Juliet"?',
        options: ['Charles Dickens', 'William Shakespeare', 'Jane Austen', 'Mark Twain'],
        correct_answer: 'William Shakespeare'
      },
      5: {
        id: 'q5',
        question: 'What is the largest ocean on Earth?',
        options: ['Atlantic Ocean', 'Indian Ocean', 'Arctic Ocean', 'Pacific Ocean'],
        correct_answer: 'Pacific Ocean'
      }
    };

    // ============================================
    // APPLICATION STATE
    // ============================================
    let appState = {
      examVersion: null,
      selectedAnswer: null,
      hasSubmitted: false,
      isBlocked: false,
      examIsOpen: false,
      tabSwitchTimer: null,
      unsubscribers: []  // Store Firestore listener unsubscribers
    };

    // ============================================
    // DOM REFERENCES
    // ============================================
    const DOM = {
      loadingOverlay: document.getElementById('loadingOverlay'),
      blockedScreen: document.getElementById('blockedScreen'),
      app: document.getElementById('app'),
      userEmailDisplay: document.getElementById('userEmailDisplay'),
      userRoleBadge: document.getElementById('userRoleBadge'),
      teacherDashboard: document.getElementById('teacherDashboard'),
      waitingRoom: document.getElementById('waitingRoom'),
      examScreen: document.getElementById('examScreen'),
      submittedScreen: document.getElementById('submittedScreen'),
      examStatusBanner: document.getElementById('examStatusBanner'),
      examStatusIcon: document.getElementById('examStatusIcon'),
      examStatusText: document.getElementById('examStatusText'),
      openExamBtn: document.getElementById('openExamBtn'),
      closeExamBtn: document.getElementById('closeExamBtn'),
      rosterBody: document.getElementById('rosterBody'),
      studentCount: document.getElementById('studentCount'),
      questionText: document.getElementById('questionText'),
      optionsContainer: document.getElementById('optionsContainer'),
      examVersionBadge: document.getElementById('examVersionBadge'),
      submitBtn: document.getElementById('submitBtn'),
      submittedAnswerText: document.getElementById('submittedAnswerText')
    };

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    /**
     * Fisher-Yates Shuffle Algorithm
     * Randomizes array in place with O(n) time complexity
     * @param {Array} array - Array to shuffle
     * @returns {Array} - Shuffled array
     */
    function fisherYatesShuffle(array) {
      const arr = [...array]; // Create copy to avoid mutation
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    /**
     * Sanitize email for Firestore document ID
     * Replaces special characters that aren't allowed
     */
    function sanitizeEmail(email) {
      return email.toLowerCase().replace(/[.#$\/\[\]]/g, '_');
    }

    /**
     * Show a specific screen, hide others
     */
    function showScreen(screenId) {
      const screens = ['teacherDashboard', 'waitingRoom', 'examScreen', 'submittedScreen'];
      screens.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.toggle('active', id === screenId);
        }
      });
    }

    /**
     * Generate random exam version (1-5)
     */
    function getRandomVersion() {
      return Math.floor(Math.random() * 5) + 1;
    }

    // ============================================
    // INITIALIZATION
    // ============================================

    /**
     * Main initialization function
     * Called when DOM is ready
     */
    async function initializeApp() {
      console.log('[INIT] Starting application...');
      console.log('[INIT] User:', USER_EMAIL);
      console.log('[INIT] Is Teacher:', IS_TEACHER);

      // Set user info in header
      DOM.userEmailDisplay.textContent = USER_EMAIL;
      DOM.userRoleBadge.textContent = IS_TEACHER ? 'Teacher' : 'Student';
      DOM.userRoleBadge.style.background = IS_TEACHER ?
        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' :
        'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';

      if (IS_TEACHER) {
        await initializeTeacherDashboard();
      } else {
        await initializeStudentView();
      }

      // Hide loading overlay, show app
      DOM.loadingOverlay.classList.add('hidden');
      DOM.app.classList.remove('hidden');
    }

    // ============================================
    // TEACHER DASHBOARD FUNCTIONS
    // ============================================

    /**
     * Initialize the Teacher Dashboard
     */
    async function initializeTeacherDashboard() {
      console.log('[TEACHER] Initializing dashboard...');

      // Show dashboard
      showScreen('teacherDashboard');

      // Listen to global quiz state
      const stateUnsubscribe = db.collection('quiz_state').doc('global')
        .onSnapshot((doc) => {
          const data = doc.data() || { isOpen: false };
          appState.examIsOpen = data.isOpen;
          updateExamStatusUI(data.isOpen);
          console.log('[TEACHER] Exam state updated:', data.isOpen);
        }, (error) => {
          console.error('[TEACHER] State listener error:', error);
        });

      appState.unsubscribers.push(stateUnsubscribe);

      // Listen to students collection
      const studentsUnsubscribe = db.collection('students')
        .onSnapshot((snapshot) => {
          updateRosterTable(snapshot.docs);
        }, (error) => {
          console.error('[TEACHER] Students listener error:', error);
        });

      appState.unsubscribers.push(studentsUnsubscribe);
    }

    /**
     * Update exam status UI elements
     */
    function updateExamStatusUI(isOpen) {
      if (isOpen) {
        DOM.examStatusBanner.className = 'exam-status-banner open';
        DOM.examStatusIcon.textContent = 'üü¢';
        DOM.examStatusText.textContent = 'Exam is OPEN';
        DOM.openExamBtn.disabled = true;
        DOM.closeExamBtn.disabled = false;
      } else {
        DOM.examStatusBanner.className = 'exam-status-banner closed';
        DOM.examStatusIcon.textContent = 'üî¥';
        DOM.examStatusText.textContent = 'Exam is CLOSED';
        DOM.openExamBtn.disabled = false;
        DOM.closeExamBtn.disabled = true;
      }
    }

    /**
     * Toggle exam open/closed state
     */
    async function toggleExamState(open) {
      try {
        console.log('[TEACHER] Setting exam state to:', open);
        await db.collection('quiz_state').doc('global').set({
          isOpen: open,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: USER_EMAIL
        }, { merge: true });
      } catch (error) {
        console.error('[TEACHER] Failed to update exam state:', error);
        alert('Failed to update exam state. Please try again.');
      }
    }

    /**
     * Update the live roster table
     */
    function updateRosterTable(docs) {
      console.log('[TEACHER] Updating roster with', docs.length, 'students');
      DOM.studentCount.textContent = `${docs.length} Student${docs.length !== 1 ? 's' : ''}`;

      DOM.rosterBody.innerHTML = docs.map(doc => {
        const data = doc.data();
        const email = data.email || doc.id;
        const version = data.examVersion || '-';
        const status = data.status || 'active';
        const answer = data.currentAnswer || null;

        // Grade the answer
        let gradeDisplay = '<span class="grade-display pending">No answer</span>';
        if (answer && version && EXAMS[version]) {
          const correct = EXAMS[version].correct_answer;
          const isCorrect = answer === correct;
          gradeDisplay = isCorrect ?
            `<span class="grade-display correct">‚úÖ ${answer}</span>` :
            `<span class="grade-display incorrect">‚ùå ${answer}</span>`;
        }

        // Status badge
        const statusBadge = status === 'blocked' ?
          '<span class="status-badge blocked">Blocked</span>' :
          '<span class="status-badge active">Active</span>';

        // Action button
        const actionBtn = status === 'blocked' ?
          `<button class="unlock-btn" onclick="unlockStudent('${doc.id}')">Unlock</button>` :
          '-';

        return `
          <tr>
            <td>${email}</td>
            <td><span class="version-badge">v${version}</span></td>
            <td>${statusBadge}</td>
            <td>${gradeDisplay}</td>
            <td>${actionBtn}</td>
          </tr>
        `;
      }).join('');
    }

    /**
     * Unlock a blocked student
     */
    async function unlockStudent(studentDocId) {
      try {
        console.log('[TEACHER] Unlocking student:', studentDocId);
        await db.collection('students').doc(studentDocId).update({
          status: 'active',
          unlockedAt: firebase.firestore.FieldValue.serverTimestamp(),
          unlockedBy: USER_EMAIL
        });
      } catch (error) {
        console.error('[TEACHER] Failed to unlock student:', error);
        alert('Failed to unlock student. Please try again.');
      }
    }

    // ============================================
    // STUDENT VIEW FUNCTIONS
    // ============================================

    /**
     * Initialize the Student View
     */
    async function initializeStudentView() {
      console.log('[STUDENT] Initializing student view...');

      // Register student and get/assign exam version
      await registerStudent();

      // Listen to own student document for status changes
      setupStudentStatusListener();

      // Listen to global quiz state
      setupQuizStateListener();

      // Setup proctoring (tab switch detection)
      setupProctoring();
    }

    /**
     * Register student in Firestore and get/assign exam version
     */
    async function registerStudent() {
      const studentDocId = sanitizeEmail(USER_EMAIL);
      const studentRef = db.collection('students').doc(studentDocId);

      try {
        const doc = await studentRef.get();

        if (doc.exists) {
          const data = doc.data();
          appState.examVersion = data.examVersion;
          appState.isBlocked = data.status === 'blocked';
          appState.hasSubmitted = data.hasSubmitted || false;
          appState.selectedAnswer = data.currentAnswer || null;
          console.log('[STUDENT] Existing student found, version:', appState.examVersion);
        } else {
          // New student - assign random version
          appState.examVersion = getRandomVersion();
          await studentRef.set({
            email: USER_EMAIL,
            examVersion: appState.examVersion,
            status: 'active',
            joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
            violations: [],
            currentAnswer: null,
            hasSubmitted: false
          });
          console.log('[STUDENT] New student registered, version:', appState.examVersion);
        }

        // Update version badge
        DOM.examVersionBadge.textContent = `Version ${appState.examVersion}`;

        // Load exam content
        loadExamContent();

        // Check if already blocked
        if (appState.isBlocked) {
          showBlockedScreen();
        }

      } catch (error) {
        console.error('[STUDENT] Registration failed:', error);
        throw error;
      }
    }

    /**
     * Load and render exam content with shuffled answers
     */
    function loadExamContent() {
      const exam = EXAMS[appState.examVersion];
      if (!exam) {
        console.error('[STUDENT] Invalid exam version:', appState.examVersion);
        return;
      }

      // Set question text
      DOM.questionText.textContent = exam.question;

      // Shuffle options using Fisher-Yates
      const shuffledOptions = fisherYatesShuffle(exam.options);
      const letters = ['A', 'B', 'C', 'D'];

      // Render options
      DOM.optionsContainer.innerHTML = shuffledOptions.map((option, index) => `
        <button class="option-btn ${appState.selectedAnswer === option ? 'selected' : ''}"
                onclick="selectOption('${option.replace(/'/g, "\\'")}')"
                ${appState.hasSubmitted ? 'disabled' : ''}>
          <span class="option-letter">${letters[index]}</span>
          <span class="option-text">${option}</span>
        </button>
      `).join('');

      // Update submit button state
      DOM.submitBtn.disabled = !appState.selectedAnswer || appState.hasSubmitted;
    }

    /**
     * Handle option selection
     */
    function selectOption(answer) {
      if (appState.hasSubmitted || appState.isBlocked) return;

      appState.selectedAnswer = answer;
      DOM.submitBtn.disabled = false;

      // Update UI
      document.querySelectorAll('.option-btn').forEach(btn => {
        const optionText = btn.querySelector('.option-text').textContent;
        btn.classList.toggle('selected', optionText === answer);
      });

      console.log('[STUDENT] Selected answer:', answer);
    }

    /**
     * Submit the answer to Firestore
     */
    async function submitAnswer() {
      if (!appState.selectedAnswer || appState.hasSubmitted || appState.isBlocked) {
        return;
      }

      DOM.submitBtn.disabled = true;
      DOM.submitBtn.textContent = 'Submitting...';

      const studentDocId = sanitizeEmail(USER_EMAIL);

      try {
        // Update student document with answer
        await db.collection('students').doc(studentDocId).update({
          currentAnswer: appState.selectedAnswer,
          hasSubmitted: true,
          submittedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Also write to responses collection
        await db.collection('responses').doc(studentDocId).set({
          email: USER_EMAIL,
          examVersion: appState.examVersion,
          answer: appState.selectedAnswer,
          submittedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        appState.hasSubmitted = true;
        DOM.submittedAnswerText.textContent = appState.selectedAnswer;
        showScreen('submittedScreen');

        console.log('[STUDENT] Answer submitted:', appState.selectedAnswer);

      } catch (error) {
        console.error('[STUDENT] Submission failed:', error);
        DOM.submitBtn.disabled = false;
        DOM.submitBtn.textContent = 'Submit Answer';

        // Check if blocked (security rules prevented write)
        if (error.code === 'permission-denied') {
          showBlockedScreen();
        } else {
          alert('Failed to submit answer. Please try again.');
        }
      }
    }

    /**
     * Setup listener for student status changes
     */
    function setupStudentStatusListener() {
      const studentDocId = sanitizeEmail(USER_EMAIL);

      const unsubscribe = db.collection('students').doc(studentDocId)
        .onSnapshot((doc) => {
          if (!doc.exists) return;

          const data = doc.data();
          const wasBlocked = appState.isBlocked;
          appState.isBlocked = data.status === 'blocked';

          // If just got blocked, show blocked screen
          if (appState.isBlocked && !wasBlocked) {
            showBlockedScreen();
          }

          // If just got unblocked, return to appropriate screen
          if (!appState.isBlocked && wasBlocked) {
            hideBlockedScreen();
          }

          console.log('[STUDENT] Status update - blocked:', appState.isBlocked);
        }, (error) => {
          console.error('[STUDENT] Status listener error:', error);
        });

      appState.unsubscribers.push(unsubscribe);
    }

    /**
     * Setup listener for global quiz state
     */
    function setupQuizStateListener() {
      const unsubscribe = db.collection('quiz_state').doc('global')
        .onSnapshot((doc) => {
          const data = doc.data() || { isOpen: false };
          const wasOpen = appState.examIsOpen;
          appState.examIsOpen = data.isOpen;

          console.log('[STUDENT] Quiz state update - open:', data.isOpen);

          // Don't change UI if blocked
          if (appState.isBlocked) return;

          // Update UI based on exam state
          if (data.isOpen && !appState.hasSubmitted) {
            showScreen('examScreen');
          } else if (appState.hasSubmitted) {
            showScreen('submittedScreen');
          } else {
            showScreen('waitingRoom');
          }
        }, (error) => {
          console.error('[STUDENT] Quiz state listener error:', error);
        });

      appState.unsubscribers.push(unsubscribe);
    }

    // ============================================
    // PROCTORING FUNCTIONS
    // ============================================

    /**
     * Setup tab switch detection proctoring
     */
    function setupProctoring() {
      console.log('[PROCTOR] Setting up visibility monitoring...');

      document.addEventListener('visibilitychange', handleVisibilityChange);

      // Also detect window blur as backup
      window.addEventListener('blur', () => {
        if (!appState.isBlocked && appState.examIsOpen && !appState.hasSubmitted) {
          console.log('[PROCTOR] Window blur detected');
          startViolationTimer();
        }
      });

      window.addEventListener('focus', () => {
        clearViolationTimer();
      });
    }

    /**
     * Handle document visibility change
     */
    function handleVisibilityChange() {
      // Skip if teacher, already blocked, exam not open, or already submitted
      if (IS_TEACHER || appState.isBlocked || !appState.examIsOpen || appState.hasSubmitted) {
        return;
      }

      if (document.hidden) {
        console.log('[PROCTOR] Tab hidden - starting violation timer');
        startViolationTimer();
      } else {
        console.log('[PROCTOR] Tab visible - clearing timer');
        clearViolationTimer();
      }
    }

    /**
     * Start the 1.5 second buffer timer before blocking
     */
    function startViolationTimer() {
      if (appState.tabSwitchTimer) return; // Already running

      appState.tabSwitchTimer = setTimeout(async () => {
        console.log('[PROCTOR] Violation confirmed - blocking student');
        await recordViolation();
      }, 1500); // 1.5 second buffer
    }

    /**
     * Clear the violation timer
     */
    function clearViolationTimer() {
      if (appState.tabSwitchTimer) {
        clearTimeout(appState.tabSwitchTimer);
        appState.tabSwitchTimer = null;
      }
    }

    /**
     * Record violation and block student
     */
    async function recordViolation() {
      const studentDocId = sanitizeEmail(USER_EMAIL);

      try {
        await db.collection('students').doc(studentDocId).update({
          status: 'blocked',
          violations: firebase.firestore.FieldValue.arrayUnion({
            type: 'tab_switch',
            timestamp: new Date().toISOString()
          }),
          blockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        appState.isBlocked = true;
        showBlockedScreen();

      } catch (error) {
        console.error('[PROCTOR] Failed to record violation:', error);
      }
    }

    /**
     * Show the blocked screen
     */
    function showBlockedScreen() {
      DOM.blockedScreen.classList.remove('hidden');
      DOM.app.classList.add('hidden');
      clearViolationTimer();
    }

    /**
     * Hide the blocked screen (when unlocked by teacher)
     */
    function hideBlockedScreen() {
      DOM.blockedScreen.classList.add('hidden');
      DOM.app.classList.remove('hidden');

      // Return to appropriate screen
      if (appState.hasSubmitted) {
        showScreen('submittedScreen');
      } else if (appState.examIsOpen) {
        showScreen('examScreen');
      } else {
        showScreen('waitingRoom');
      }
    }

    // ============================================
    // CLEANUP
    // ============================================

    /**
     * Cleanup function for when page unloads
     */
    function cleanup() {
      clearViolationTimer();
      appState.unsubscribers.forEach(unsubscribe => {
        if (typeof unsubscribe === 'function') {
          unsubscribe();
        }
      });
    }

    window.addEventListener('beforeunload', cleanup);

    // ============================================
    // START APPLICATION
    // ============================================
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
