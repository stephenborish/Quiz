name: Deploy to Google Apps Script

on:
  push:
    branches:
      - main
      - claude/**
  workflow_dispatch:  # Allows manual trigger from GitHub mobile app

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Create clasprc.json
        env:
          CLASP_CREDS: ${{ secrets.CLASP_CREDENTIALS }}
        run: |
          # Check if credentials secret is set
          if [ -z "$CLASP_CREDS" ]; then
            echo "‚ùå ERROR: CLASP_CREDENTIALS secret is not set or is empty"
            echo ""
            echo "üìã To fix this:"
            echo "1. Run 'clasp login' locally"
            echo "2. Copy the contents of ~/.clasprc.json"
            echo "3. Add it as a GitHub secret named CLASP_CREDENTIALS"
            exit 1
          fi

          echo "$CLASP_CREDS" > ~/.clasprc.json
          echo "‚úÖ Clasp credentials configured"

          # Validate JSON format
          echo "Validating JSON format..."
          if ! jq empty ~/.clasprc.json 2>/dev/null; then
            echo "‚ùå ERROR: Invalid JSON in CLASP_CREDENTIALS secret"
            echo "Please check your GitHub secret is valid JSON"
            exit 1
          fi
          echo "‚úÖ JSON format is valid"

          # Check for required OAuth fields
          if ! jq -e '.token.access_token' ~/.clasprc.json > /dev/null 2>&1; then
            echo "‚ö†Ô∏è WARNING: access_token not found in credentials"
            echo "Credentials may need to be refreshed"
          fi

          # Check token expiration
          EXPIRY=$(jq -r '.token.expiry_date // 0' ~/.clasprc.json 2>/dev/null)
          CURRENT_TIME=$(($(date +%s) * 1000))
          if [ "$EXPIRY" != "0" ] && [ "$EXPIRY" != "null" ] && [ "$EXPIRY" -lt "$CURRENT_TIME" ]; then
            echo "‚ö†Ô∏è WARNING: OAuth token appears to be expired"
            echo "Token expiry: $EXPIRY, Current time: $CURRENT_TIME"
            echo "Clasp will attempt to refresh using refresh_token"
          fi

      - name: Verify clasp authentication
        run: |
          echo "Checking clasp authentication status..."
          clasp login --status || echo "Proceeding with credentials from ~/.clasprc.json"

      - name: Verify files before push
        run: |
          echo "Current directory: $(pwd)"
          echo "Listing files:"
          ls -la
          echo ""
          echo "Checking for required files:"
          if [ -f ".clasp.json" ]; then
            echo "‚úÖ .clasp.json found"
            cat .clasp.json
          else
            echo "‚ùå .clasp.json NOT FOUND"
          fi
          if [ -f "appsscript.json" ]; then
            echo "‚úÖ appsscript.json found"
            cat appsscript.json
          else
            echo "‚ùå appsscript.json NOT FOUND"
          fi
          if [ -f "Code.gs" ]; then
            echo "‚úÖ Code.gs found ($(wc -l < Code.gs) lines)"
          else
            echo "‚ùå Code.gs NOT FOUND"
          fi
          if [ -f "Index.html" ]; then
            echo "‚úÖ Index.html found ($(wc -l < Index.html) lines)"
          else
            echo "‚ùå Index.html NOT FOUND"
          fi

      - name: Push to Apps Script
        run: |
          echo "Pushing code to Apps Script..."
          clasp push -f
          echo "‚úÖ Push completed successfully"

      - name: Deploy new version
        run: |
          echo "Creating new deployment version..."
          DEPLOY_OUTPUT=$(clasp deploy --description "Auto-deploy from GitHub Actions - $(date -u +%Y-%m-%d_%H:%M:%S)" 2>&1)
          echo "$DEPLOY_OUTPUT"
          # Extract deployment ID if available
          DEPLOY_ID=$(echo "$DEPLOY_OUTPUT" | grep -oP '(?<=- )[A-Za-z0-9_-]+(?= @)' | head -1 || true)
          if [ -n "$DEPLOY_ID" ]; then
            echo "‚úÖ New deployment created: $DEPLOY_ID"
          else
            echo "‚ö†Ô∏è Could not extract deployment ID, but deploy may have succeeded"
          fi

      - name: Deployment Summary
        run: |
          echo "‚úÖ Successfully deployed to Apps Script!"
          echo "Script ID: 1t0nNRgRA0bxkWgMEnrjTpGwL-dZHGyvsd7QWYidLk32mWp0FeBsElIZb"
          echo "Files deployed: Code.gs, Index.html, appsscript.json"
          echo ""
          echo "üìã Next steps:"
          echo "1. Verify the deployment at: https://script.google.com/macros/s/AKfycbwlDegxdxlTsVbXQhg4gXYEtToZ9P3eks6GTaiP2dRYdqM3HgwYbRCY7MixeYALrbY_Jexec"
          echo "2. Check the Apps Script dashboard for the latest version"
